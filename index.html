<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>DualOiNet 10 · Portal Supremo + Streaming + Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#050715" />
<meta name="theme-color" content="#050814" />

<link rel="manifest" href="./manifest.webmanifest" />

<link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
<link rel="apple-touch-icon" href="./icon-192.png" />

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <style>
    /* ============================
       TOKENS · NEBULA PRO + MADEIRA
       ============================ */

    :root{
      --bg-main: radial-gradient(circle at top, #141429 0%, #050715 45%, #020309 100%);
      --bg-overlay-default: radial-gradient(circle at 75% 15%, #ff7ad9 0%, #ff9ed5 22%, transparent 68%);
      --bg-overlay-warm: radial-gradient(circle at 80% 15%, #ff9a6c 0%, #ffce8a 22%, transparent 68%);
      --bg-overlay-cool: radial-gradient(circle at 25% 10%, #00f6ff 0%, #7cf6ff 22%, transparent 68%);
      --bg-overlay-deep: radial-gradient(circle at 5% 10%, #9f7dff 0%, #ff7ad9 22%, transparent 70%);

      --accent-main:#ff7ad9;
      --accent-warm:#ffb5e2;
      --accent-cold:#00f6ff;

      --card-bg: rgba(8,10,25,0.96);
      --card-soft: rgba(13,17,40,0.96);
      --border-soft: rgba(145,166,255,0.45);

      --text-main:#fdfdff;
      --text-soft:#c6c9ff;
      --text-muted:#7b81a8;

      --radius-xl:28px;
      --radius-lg:20px;
      --radius-md:16px;

      --shadow-soft:0 18px 40px rgba(0,0,0,0.78);

      --hero-height:260px;
      --rail-card-width:160px;
      --rail-card-height:96px;

      --hero-img-url:url("https://images.pexels.com/photos/1181675/pexels-photo-1181675.jpeg?auto=compress&cs=tinysrgb&w=800");
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      margin:0;
      min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,sans-serif;
      color:var(--text-main);
      background:var(--bg-main);
      display:flex;
      justify-content:center;
      align-items:stretch;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:var(--bg-overlay-default);
      opacity:0;
      pointer-events:none;
      animation:dawnFade 1.6s ease-out 0.12s forwards;
      z-index:-1;
    }

    body[data-stream-bg="warm"]::before{
      background:var(--bg-overlay-warm);
    }
    body[data-stream-bg="cool"]::before{
      background:var(--bg-overlay-cool);
    }
    body[data-stream-bg="deep"]::before{
      background:var(--bg-overlay-deep);
    }

    @keyframes dawnFade{
      0%{opacity:0;filter:blur(14px);}
      40%{opacity:0.6;filter:blur(7px);}
      100%{opacity:1;filter:blur(0);}
    }

    .shell{
      width:100%;
      max-width:480px;
      margin:0 auto;
      padding:18px 0 26px;
      display:flex;
      flex-direction:column;
      gap:16px;
      position:relative;
      z-index:1;
      animation:fadeUp 0.75s ease-out 0.18s both;
    }

    @keyframes fadeUp{
      from{opacity:0;transform:translateY(18px);}
      to{opacity:1;transform:translateY(0);}
    }

   /* PATCH · TEXT BLOCKS & CALLOUTS · KOBLLUX BEAUTY v1  */
/* MOBILE-FIRST VERTICAL HARD-LOCK */

:root{
  --txt-block-bg: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.9));
  --txt-block-border: rgba(148,163,184,0.55);
  --txt-block-shadow: 0 14px 30px rgba(0,0,0,0.72);

  --callout-info-bg: radial-gradient(circle at 0 0, rgba(56,189,248,0.28), rgba(15,23,42,0.96));
  --callout-info-border: rgba(56,189,248,0.75);

  --callout-warn-bg: radial-gradient(circle at 0 0, rgba(251,191,36,0.32), rgba(15,23,42,0.98));
  --callout-warn-border: rgba(251,191,36,0.85);

  --callout-success-bg: radial-gradient(circle at 0 0, rgba(34,197,94,0.32), rgba(15,23,42,0.98));
  --callout-success-border: rgba(34,197,94,0.85);

  --callout-aside-bg: radial-gradient(circle at 0 0, rgba(148,163,184,0.22), rgba(15,23,42,0.98));
  --callout-aside-border: rgba(148,163,184,0.7);

  --callout-question-bg: radial-gradient(circle at 0 0, rgba(129,140,248,0.32), rgba(15,23,42,0.98));
  --callout-question-border: rgba(129,140,248,0.9);
}

/* 1) TEXTOS SOLTOS DENTRO DOS STACKS VÃO VIRAR BLOCOS */

.stack-body > p{
  margin: 0 0 0.55rem;
  padding: 7px 10px;
  border-radius: 10px;
  background: var(--txt-block-bg);
  border: 1px solid var(--txt-block-border);
  box-shadow: var(--txt-block-shadow);
  font-size: 0.86rem;
  line-height: 1.6;
  color: var(--text-soft,#cbd5f5);
}

/* Quando tiver vários parágrafos seguidos, eles grudam visualmente */
.stack-body > p + p{
  margin-top: 4px;
}

/* Se tiver .flow-text, respeita ela (só ajusta um pouco) */
.stack-body .flow-text{
  margin: 0 0 0.6rem;
  padding: 7px 10px;
  border-radius: 10px;
  background: var(--txt-block-bg);
  border: 1px solid var(--txt-block-border);
  box-shadow: var(--txt-block-shadow);
  font-size: 0.88rem;
  line-height: 1.7;
}

/* 2) BLOCOS “RENDER RESPONSE” / LIVRO VIVO */

.render-response,
.render-block,
.infodoc-block{
  border-radius: 14px;
  padding: 10px 11px;
  margin: 0 0 0.7rem;
  background: radial-gradient(circle at top, rgba(15,23,42,0.98), rgba(2,6,23,0.98));
  border: 1px solid rgba(148,163,184,0.55);
  box-shadow: 0 16px 40px rgba(0,0,0,0.9);
  font-size: 0.88rem;
  line-height: 1.7;
  color: var(--text-soft,#d1ddff);
}

.render-response h1,
.render-response h2,
.render-response h3,
.render-response h4,
.render-block h1,
.render-block h2,
.render-block h3,
.render-block h4,
.infodoc-block h1,
.infodoc-block h2,
.infodoc-block h3,
.infodoc-block h4{
  margin: 0 0 0.4rem;
  font-size: 0.9rem;
  letter-spacing: .04em;
  text-transform: uppercase;
  color: var(--text-strong,#f9fafb);
}

.render-response p,
.render-block p,
.infodoc-block p{
  margin: 0 0 0.45rem;
}

.render-response p:last-child,
.render-block p:last-child,
.infodoc-block p:last-child{
  margin-bottom: 0;
}

/* Código dentro da resposta rende bonitinho também */
.render-response code,
.render-block code,
.infodoc-block code{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  font-size: 0.78rem;
  padding: 1px 4px;
  border-radius: 6px;
  background: rgba(15,23,42,0.95);
  border: 1px solid rgba(75,85,99,0.9);
}

/* 3) CALLOUTS TIPO LIVRO VIVO (::info, ::warn, ::success, ::aside, ::question)  */

/* Base genérica (caso teu parser gere .callout) */
.callout,
.infodoc-callout{
  position: relative;
  margin: 0 0 0.6rem;
  padding: 7px 9px 7px 11px;
  border-radius: 12px;
  border: 1px solid var(--callout-aside-border);
  background: var(--callout-aside-bg);
  font-size: 0.84rem;
  line-height: 1.6;
  color: var(--text-soft,#e5e7f5);
}

.callout::before,
.infodoc-callout::before{
  content: "⊙";
  position: absolute;
  left: 8px;
  top: 7px;
  font-size: 11px;
  opacity: 0.9;
}

/* Info */
.callout.info,
.infodoc-callout.info{
  background: var(--callout-info-bg);
  border-color: var(--callout-info-border);
}
.callout.info::before,
.infodoc-callout.info::before{
  content: "ℹ";
}

/* Warn / danger */
.callout.warn,
.callout.warning,
.infodoc-callout.warn,
.infodoc-callout.warning{
  background: var(--callout-warn-bg);
  border-color: var(--callout-warn-border);
}
.callout.warn::before,
.callout.warning::before,
.infodoc-callout.warn::before,
.infodoc-callout.warning::before{
  content: "⚠";
}

/* Success */
.callout.success,
.infodoc-callout.success{
  background: var(--callout-success-bg);
  border-color: var(--callout-success-border);
}
.callout.success::before,
.infodoc-callout.success::before{
  content: "✔";
}

/* Aside (observação lateral) */
.callout.aside,
.infodoc-callout.aside{
  background: var(--callout-aside-bg);
  border-color: var(--callout-aside-border);
}
.callout.aside::before,
.infodoc-callout.aside::before{
  content: "☍";
}

/* Question (pergunta / reflexão) */
.callout.question,
.infodoc-callout.question{
  background: var(--callout-question-bg);
  border-color: var(--callout-question-border);
}
.callout.question::before,
.infodoc-callout.question::before{
  content: "?";
}

/* Títulos dentro de callout (se tiver) */
.callout strong:first-child,
.infodoc-callout strong:first-child{
  display:block;
  margin-bottom: 2px;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: #f9fafb;
}
 /* HEADER */

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:0 16px;
    }

    .header-left{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .menu-button{
      width:30px;height:30px;
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.7);
      background:rgba(8,10,30,0.96);
      color:var(--text-soft);
      font-size:16px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 10px 26px rgba(0,0,0,0.85);
    }

    .logo-title{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .logo-title span:nth-child(1){
      font-size:11px;
      letter-spacing:0.14em;
      text-transform:uppercase;
      color:var(--text-muted);
    }
    .logo-title span:nth-child(2){
      font-size:15px;
      font-weight:600;
      color:var(--text-soft);
    }

    .mode-toggle{
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      padding:4px 10px 4px 6px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--text-soft);
      background:
        radial-gradient(circle at 0% 0%, rgba(0,246,255,0.35), transparent 60%),
        rgba(4,8,28,0.92);
      box-shadow:0 10px 26px rgba(0,0,0,0.75);
      backdrop-filter:blur(10px);
      -webkit-backdrop-filter:blur(10px);
      cursor:pointer;
      transition:transform 0.2s ease,background 0.25s ease,border-color 0.25s ease;
    }
    .mode-toggle:hover{transform:translateY(-1px);}
    .mode-dot{
      width:16px;height:16px;border-radius:999px;
      background:radial-gradient(circle at 30% 20%, #ffffff, var(--accent-cold));
      box-shadow:0 0 10px rgba(0,246,255,0.85);
    }

    body[data-theme="madeira"] .mode-toggle{
      background:
        radial-gradient(circle at 0% 0%, rgba(255,180,140,0.55), transparent 60%),
        rgba(14,8,4,0.98);
      border-color:rgba(255,200,160,0.9);
    }
    body[data-theme="madeira"] .mode-dot{
      background:radial-gradient(circle at 30% 20%, #ffffff, #ffce8a);
      box-shadow:0 0 14px rgba(255,200,160,0.98);
    }

    /* HERO · STREAMING DO DIA */

    .hero-stream{
      margin-top:4px;
      padding:0 16px;
    }

    .hero-card{
      position:relative;
      height:var(--hero-height);
      border-radius:22px;
      overflow:hidden;
      box-shadow:0 22px 44px rgba(0,0,0,0.95);
      border:1px solid rgba(153,175,255,0.35);
      background:
        radial-gradient(circle at 10% 0%, rgba(255,149,214,0.32), transparent 55%),
        linear-gradient(135deg, rgba(8,10,35,0.98), rgba(4,5,18,0.98));
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      cursor:pointer;
    }

    .hero-bg{
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 80% 0%, rgba(0,246,255,0.35), transparent 55%),
        radial-gradient(circle at 0 100%, rgba(255,122,191,0.45), transparent 55%),
        var(--hero-img-url);
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      mix-blend-mode:lighten;
      opacity:0.6;
      pointer-events:none;
      transition:opacity 0.25s ease, transform 0.25s ease;
    }

    .hero-gradient{
      position:absolute;
      inset:0;
      background:linear-gradient(180deg, rgba(3,5,18,0.0) 0%, rgba(3,5,18,0.4) 40%, rgba(3,5,18,0.95) 100%);
    }

    .hero-content{
      position:relative;
      padding:14px 14px 14px;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .hero-tag-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:11px;
      color:var(--text-muted);
    }

    .hero-tag{
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(255,149,214,0.75);
      background:rgba(26,12,32,0.96);
      color:#ffd8f2;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.14em;
    }

    .hero-mode-pill{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(5,7,24,0.96);
      font-size:10px;
      display:flex;
      align-items:center;
      gap:5px;
      color:var(--text-soft);
    }
    .hero-mode-pill span.label{
      opacity:0.9;
    }
    .hero-mode-pill span.dot{
      width:6px;height:6px;border-radius:999px;
      background:#60f7b3;
      box-shadow:0 0 8px rgba(96,247,179,0.9);
    }

    .hero-title{
      font-size:20px;
      font-weight:650;
      letter-spacing:0.02em;
    }

    .hero-subtitle{
      font-size:13px;
      color:var(--accent-warm);
    }

    .hero-actions{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:4px;
    }

    .btn-primary{
      border-radius:999px;
      border:none;
      padding:7px 14px;
      font-size:13px;
      font-weight:500;
      background:radial-gradient(circle at 20% 0%, #ffffff, var(--accent-main));
      color:#1a0c14;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      box-shadow:0 0 16px rgba(255,91,155,0.9);
    }

    .btn-secondary{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.7);
      padding:6px 12px;
      font-size:12px;
      background:rgba(6,9,28,0.95);
      color:var(--text-soft);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }

    .tts-btn{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.8);
      background:
        radial-gradient(circle at 20% 0%, rgba(255,255,255,0.8), var(--accent-cold));
      color:#10141f;
      font-size:14px;
      width:28px;height:28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 0 12px rgba(0,246,255,0.85);
      flex-shrink:0;
    }

    /* GREETING + INTENÇÃO */

    .greeting-strip{
      padding:4px 16px 0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .greeting-line{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      color:var(--text-soft);
    }
    .greeting-name{font-weight:600;}
    .time-mini{
      font-size:11px;
      color:var(--text-muted);
    }

    .intent369-field{
      margin-top:2px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(145,166,255,0.6);
      background:rgba(9,11,31,0.96);
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow:0 10px 24px rgba(0,0,0,0.85);
      font-size:12px;
    }

    .intent369-icon{
      font-size:15px;
      color:var(--accent-warm);
    }

    .intent369-input{
      flex:1;
      min-width:0;
      border:none;
      background:transparent;
      color:var(--text-soft);
      font-size:12px;
      outline:none;
    }
    .intent369-input::placeholder{
      color:rgba(145,155,210,0.85);
    }

    /* SEÇÕES + RAILS */

    .section-title{
      font-size:14px;
      font-weight:500;
      padding:12px 16px 4px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      color:var(--text-soft);
      gap:6px;
    }
    .section-title span:nth-child(2){
      font-size:11px;
      color:var(--text-muted);
    }

    .section-title.with-toggle{
      align-items:center;
    }
    .section-title-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .apps-view-toggle{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.8);
      background:rgba(7,9,28,0.95);
      color:var(--text-soft);
      font-size:11px;
      padding:4px 10px;
      cursor:pointer;
      white-space:nowrap;
    }
    body[data-apps-view="grid"] .apps-view-toggle{
      background:rgba(255,149,214,0.15);
      border-color:rgba(255,149,214,0.9);
      color:#ffd8f2;
    }

    .rail{
      padding:0 16px 4px;
    }
    .rail-track{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
    }
    .rail-track::-webkit-scrollbar{height:4px;}
    .rail-track::-webkit-scrollbar-thumb{
      background:rgba(120,135,210,0.7);
      border-radius:999px;
    }

    .stream-card{
      min-width:var(--rail-card-width);
      max-width:var(--rail-card-width);
      height:var(--rail-card-height);
      border-radius:14px;
      border:1px solid rgba(92,115,205,0.9);
      background:
        radial-gradient(circle at 10% 0%, rgba(255,149,214,0.25), rgba(10,13,35,0.96));
      box-shadow:0 12px 26px rgba(0,0,0,0.92);
      scroll-snap-align:start;
      position:relative;
      overflow:hidden;
      cursor:pointer;
    }

    .stream-thumb{
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      mix-blend-mode:lighten;
      opacity:0.62;
      transform:scale(1.05);
      transition:opacity 0.2s ease, transform 0.2s ease;
    }

    .stream-inner{
      position:relative;
      padding:8px 8px 8px;
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
    }

    .stream-card:hover .stream-thumb{
      opacity:0.8;
      transform:scale(1.08);
    }

    .stream-tag{
      position:absolute;
      top:6px;left:8px;
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.85);
      background:rgba(5,8,26,0.9);
      color:#e0e3ff;
    }

    .stream-tts{
      position:absolute;
      top:6px;right:6px;
    }

    .stream-title{
      font-size:12px;
      font-weight:500;
      text-shadow:0 1px 4px rgba(0,0,0,0.8);
    }
    .stream-sub{
      font-size:10px;
      color:var(--text-muted);
      text-shadow:0 1px 3px rgba(0,0,0,0.8);
    }

    /* APP CARDS · GRADIENT GROUPS */

    .stream-card.app-card{
      border-color:rgba(255,181,226,0.9);
      background:
        radial-gradient(circle at 15% 0%, rgba(255,181,226,0.45), transparent 55%),
        radial-gradient(circle at 85% 100%, rgba(0,246,255,0.35), transparent 55%),
        rgba(6,9,28,0.98);
    }
    .app-card .stream-thumb{
      opacity:0.35;
      mix-blend-mode:screen;
    }

    .app-card[data-app-group="dual"]{
      background:
        radial-gradient(circle at 10% 0%, rgba(0,246,255,0.55), transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(255,122,217,0.5), transparent 55%),
        rgba(3,6,24,0.98);
    }

    .app-card[data-app-group="solar"]{
      background:
        radial-gradient(circle at 0 0, rgba(255,214,130,0.75), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(255,125,102,0.65), transparent 55%),
        rgba(22,12,6,0.98);
    }

    .app-card[data-app-group="docs"]{
      background:
        radial-gradient(circle at 0 0, rgba(172,237,255,0.6), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(154,184,255,0.6), transparent 55%),
        rgba(5,8,26,0.98);
    }

    .app-card[data-app-group="base"]{
      background:
        radial-gradient(circle at 20% 0, rgba(255,181,226,0.5), transparent 55%),
        radial-gradient(circle at 80% 100%, rgba(0,246,255,0.3), transparent 55%),
        rgba(6,9,28,0.98);
    }

    /* APPS GRID (PLAY STORE) */

    .apps-grid-section{
      padding:0 16px 10px;
    }
    .apps-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    .apps-grid .stream-card.app-card{
      min-width:0;
      max-width:none;
      height:auto;
    }

    #portalGridSection{display:none;}
    body[data-apps-view="grid"] #portalRailSection{display:none;}
    body[data-apps-view="grid"] #portalGridSection{display:block;}

    /* STACKS · APPS & UPLOAD HTML & CHAT */

    .apps-stacks{
      padding:10px 16px 2px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    details.stack-card{
      background:var(--card-soft);
      border-radius:var(--radius-lg);
      border:1px solid rgba(120,143,230,0.65);
      box-shadow:0 14px 32px rgba(0,0,0,0.85);
      backdrop-filter:blur(18px);
      -webkit-backdrop-filter:blur(18px);
      overflow:hidden;
    }

/* Sanfonas de vídeos (Sinopses, Ambiente, Neuro, Meditações) */
.video-accordion{
  padding: 4px 16px 0;
}

.video-accordion details.stack-card{
  margin-top: 6px;
}

    details.stack-card[open]{
      border-color:rgba(255,149,214,0.95);
      background:radial-gradient(circle at 10% 0%, rgba(255,149,214,0.18), rgba(6,9,30,0.98));
    }

    details.stack-card>summary{
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
    }
    details.stack-card>summary::-webkit-details-marker{display:none;}

    .stack-summary-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .stack-title{
      font-size:13px;
      font-weight:500;
    }
    .stack-sub{
      font-size:11px;
      color:var(--text-muted);
    }
    .stack-pill{
      font-size:11px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.9);
      background:rgba(7,10,32,0.98);
      color:var(--text-soft);
    }

    .stack-body{
      padding:0 12px 10px;
      border-top:1px solid rgba(92,115,205,0.7);
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
    }

    .stack-field-label{
      font-size:11px;
      color:var(--text-muted);
      margin-bottom:2px;
    }

    .stack-input{
      width:100%;
      border-radius:999px;
      border:1px solid rgba(145,166,255,0.7);
      background:rgba(5,7,24,0.98);
      color:var(--text-soft);
      padding:6px 10px;
      font-size:12px;
      outline:none;
    }
    .stack-input::placeholder{
      color:rgba(145,155,210,0.85);
    }

    .stack-input-row{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    @media (min-width:520px){
      .stack-input-row{flex-direction:row;}
    }

    .capsule-list{
      list-style:none;
      padding:0;
      margin:4px 0 0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .capsule-pill{
      padding:7px 9px;
      border-radius:11px;
      background:rgba(9,11,31,0.98);
      border:1px solid rgba(92,115,205,0.85);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .capsule-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .capsule-title{font-size:12px;}
    .capsule-tag{
      font-size:10px;
      color:var(--text-muted);
    }

    .capsule-actions{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:flex-end;
    }
    @media (min-width:420px){
      .capsule-actions{flex-direction:row;}
    }

    .pill-btn{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.85);
      background:rgba(7,9,28,0.98);
      color:var(--text-soft);
      font-size:10px;
      padding:4px 7px;
      cursor:pointer;
      white-space:nowrap;
    }

    .stack-footnote{
      font-size:10px;
      color:var(--text-muted);
    }

    .stack-viewer-card{
      margin-top:4px;
      border-radius:var(--radius-lg);
      border:1px solid rgba(120,143,230,0.7);
      background:rgba(8,10,30,0.98);
      box-shadow:0 16px 36px rgba(0,0,0,0.9);
      overflow:hidden;
    }

    .stack-viewer-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px 8px;
      border-bottom:1px solid rgba(72,94,192,0.8);
    }
    .stack-viewer-title{
      font-size:13px;
      font-weight:500;
    }
    .stack-viewer-sub{
      font-size:11px;
      color:var(--text-muted);
    }
    .stack-viewer-reset{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.85);
      background:rgba(6,9,30,0.98);
      color:var(--text-soft);
      font-size:10px;
      padding:4px 8px;
      cursor:pointer;
    }

    .stack-viewer-frame{
      height:620px;
      background:radial-gradient(circle at 0 0, rgba(0,246,255,0.16), rgba(3,5,16,0.98));
    }
    .stack-viewer-frame iframe{
      width:100%;
      height:100%;
      border:0;
      border-radius:0 0 var(--radius-lg) var(--radius-lg);
    }
    .stack-viewer-note{
      padding:6px 12px 10px;
      font-size:10px;
      color:var(--text-muted);
    }

    /* CHAT PANEL · SANFONADO SUPREMO */

    .chat-config-grid{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    @media (min-width:520px){
      .chat-config-grid{
        flex-direction:row;
      }
    }

    .chat-config-col{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .chat-textarea{
      width:100%;
      min-height:80px;
      resize:vertical;
      border-radius:14px;
      border:1px solid rgba(145,166,255,0.7);
      background:rgba(5,7,24,0.98);
      color:var(--text-soft);
      font-size:11px;
      padding:8px 10px;
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      outline:none;
    }
    .chat-textarea::placeholder{
      color:rgba(145,155,210,0.85);
    }

    .chat-panel-card{
      margin-top:4px;
      border-radius:var(--radius-lg);
      border:1px solid rgba(120,143,230,0.7);
      background:rgba(8,10,30,0.98);
      box-shadow:0 16px 36px rgba(0,0,0,0.9);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      max-height:320px;
    }

    .chat-panel-header{
      padding:8px 12px 6px;
      border-bottom:1px solid rgba(72,94,192,0.8);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-size:11px;
    }
    .chat-panel-title{
      font-size:13px;
      font-weight:500;
    }
    .chat-panel-sub{
      font-size:11px;
      color:var(--text-muted);
    }

    .chat-panel-mode-pill{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.9);
      padding:3px 8px;
      font-size:10px;
      background:rgba(7,10,32,0.98);
      color:var(--text-soft);
      white-space:nowrap;
    }

    .chat-messages{
      flex:1;
      padding:8px 10px;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }

    .chat-message{
      max-width:88%;
      padding:6px 9px;
      border-radius:13px;
      line-height:1.4;
      box-shadow:0 3px 10px rgba(0,0,0,0.6);
    }
    .chat-message.me{
      align-self:flex-end;
      background:radial-gradient(circle at 0 0, rgba(0,246,255,0.25), rgba(6,9,30,0.98));
      border:1px solid rgba(0,246,255,0.9);
    }
    .chat-message.ai{
      align-self:flex-start;
      background:radial-gradient(circle at 100% 0, rgba(255,149,214,0.25), rgba(8,10,33,0.98));
      border:1px solid rgba(255,149,214,0.9);
    }

    .chat-input-row{
      padding:8px 10px 9px;
      border-top:1px solid rgba(72,94,192,0.8);
      display:flex;
      gap:6px;
      align-items:flex-end;
      background:rgba(4,6,20,0.98);
    }

    .chat-input{
      flex:1;
      border-radius:999px;
      border:1px solid rgba(145,166,255,0.7);
      background:rgba(5,7,24,0.98);
      color:var(--text-soft);
      font-size:12px;
      padding:7px 10px;
      outline:none;
    }
    .chat-input::placeholder{
      color:rgba(145,155,210,0.85);
    }

    .chat-send-btn{
      border-radius:999px;
      border:none;
      padding:7px 11px;
      background:radial-gradient(circle at 20% 0, #ffffff, var(--accent-main));
      color:#160711;
      font-size:13px;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 0 12px rgba(255,91,155,0.9);
      flex-shrink:0;
    }

    /* VIEWER BOTTOM-SHEET (STREAMING + APPS) */

    .view-overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at top, rgba(5,8,24,0.4), rgba(0,0,0,0.92));
      opacity:0;
      pointer-events:none;
      transition:opacity 0.24s ease;
      z-index:55;
    }
    .view-overlay.visible{
      opacity:1;
      pointer-events:auto;
    }

    .view-panel{
      position:absolute;
      left:50%;bottom:0;
      transform:translate(-50%,110%);
      width:100%;
      max-width:480px;
      background:rgba(6,9,28,0.98);
      border-radius:22px 22px 0 0;
      box-shadow:0 -20px 44px rgba(0,0,0,0.98);
      border-top:1px solid rgba(153,175,255,0.5);
      transition:transform 0.26s ease-out;
      display:flex;
      flex-direction:column;
      max-height:90vh;
    }
    .view-overlay.visible .view-panel{
      transform:translate(-50%,0);
    }

    .view-header{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 14px 6px;
      border-bottom:1px solid rgba(55,72,150,0.7);
    }
    .view-back{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.8);
      background:rgba(11,15,40,0.98);
      color:var(--text-soft);
      width:28px;height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      cursor:pointer;
    }
    .view-titles{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .view-title{
      font-size:15px;
      font-weight:600;
    }
    .view-subtitle{
      font-size:12px;
      color:var(--text-muted);
    }

    .view-body{
      padding:10px 14px 16px;
      overflow-y:auto;
      font-size:13px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .view-note{
      font-size:11px;
      color:var(--text-muted);
    }

    #viewVideoHolder iframe{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(92,115,205,0.8);
      box-shadow:0 14px 34px rgba(0,0,0,0.9);
      min-height:210px;
    }

    /* MENU LATERAL */

    .menu-overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 0 0, rgba(11,16,40,0.95), rgba(0,0,0,0.9));
      opacity:0;
      pointer-events:none;
      transition:opacity 0.22s ease;
      z-index:60;
    }
    .menu-overlay.visible{
      opacity:1;
      pointer-events:auto;
    }
    .menu-panel{
      position:absolute;
      left:0;top:0;bottom:0;
      width:min(80%,320px);
      background:rgba(5,8,26,0.98);
      border-right:1px solid rgba(153,175,255,0.5);
      box-shadow:18px 0 40px rgba(0,0,0,0.95);
      padding:14px 14px 18px;
      transform:translateX(-100%);
      transition:transform 0.24s ease-out;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .menu-overlay.visible .menu-panel{
      transform:translateX(0);
    }
    .menu-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .menu-title{
      font-size:14px;
      font-weight:600;
    }
    .menu-close{
      border-radius:999px;
      border:1px solid rgba(153,175,255,0.7);
      background:rgba(11,15,40,0.96);
      color:var(--text-soft);
      width:28px;height:28px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
      cursor:pointer;
    }
    .menu-section-title{
      font-size:11px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:var(--text-muted);
    }
    .menu-section{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }
    .menu-item{
      border-radius:12px;
      border:1px solid rgba(92,115,205,0.8);
      background:rgba(9,12,33,0.96);
      color:var(--text-soft);
      padding:8px 10px;
      font-size:13px;
      text-align:left;
      cursor:pointer;
    }
    .menu-item span{
      font-size:11px;
      color:var(--text-muted);
      display:block;
      margin-top:2px;
    }

    /* BODY THEME HOOK (NEBULA vs MADEIRA) */

    body[data-theme="madeira"]{
      --accent-main:#ffb36f;
      --accent-warm:#ffe1b3;
      --accent-cold:#9ff0c8;

      --card-bg:rgba(22,12,6,0.96);
      --card-soft:rgba(25,13,7,0.96);
      --border-soft:rgba(255,210,140,0.55);

      --text-soft:#f6e2c1;
      --text-muted:#b9966c;
    }

/* OVERRIDE · VIEWER PRINCIPAL v2
   Compacto = antigo maximizado
   Full = modo app 9:16 vertical  */

.view-overlay{
  transition: background 0.25s ease;
}

.view-panel{
  transition: max-height 0.25s ease, transform 0.25s ease;
}

/* MODO COMPACTO
   - Padrão “maximizado antigo”
   - Viewer grande, mas ainda com respiro pro resto da UI */
.view-overlay[data-size="compact"] .view-panel{
  max-height: 96vh;           /* era 260px; agora quase tela cheia */
}

/* Altura boa pro app/vídeo em modo compacto */
.view-overlay[data-size="compact"] #viewVideoHolder iframe{
  width: 100%;
  min-height: min(60vh, 520px);
}

/* MODO FULL
   - Modo app 9:16 vertical
   - Quase tela inteira, foco total no iFrame */
.view-overlay[data-size="full"] .view-panel{
  max-height: 100vh;
}

/* iFrame em 9:16 vertical (height > width) */
.view-overlay[data-size="full"] #viewVideoHolder iframe{
  width: 100%;
  aspect-ratio: 9 / 16;         /* vertical */
  min-height: min(80vh, 720px); /* fallback se aspect-ratio não pegar */
}

/* Opcional: corpo rolável no full, pra não estourar */
.view-overlay[data-size="full"] .view-body{
  max-height: calc(100vh - 64px); /* header + margem */
  overflow-y: auto;
}

/* Em telas muito pequenas, dá uma segurada */
@media (max-width: 640px){
  .view-overlay[data-size="compact"] #viewVideoHolder iframe{
    min-height: 33vh; margin-bottom:12vh;
  }
  .view-overlay[data-size="full"] #viewVideoHolder iframe{
    min-height: 87vh; margin-bottom:12vh;
  }
}

  </style>

 <style>
  /* MOBILE-FIRST VERTICAL HARD-LOCK */

  :root {
    /* Nebula Pro vibes (baseado nos teus apps)  [oai_citation:0‡nebula-live-editor-card-1.html](sediment://file_000000001ba471f5afdc1c77dcbd16f9)  [oai_citation:1‡Injetor-V9.html](sediment://file_00000000fdf471f597ec762815f52b9f) */
    --nebula-bg-1: #050015;
    --nebula-bg-2: #0b021f;
    --nebula-bg-3: #02000a;

    --nebula-accent-pink: #ff77e9;
    --nebula-accent-cyan: #5df2ff;
    --nebula-accent-green: #7bffb0;
    --nebula-accent-amber: #ffb56c;

    --nebula-text-main: #f9fbff;
    --nebula-text-soft: #c5bddf;
    --nebula-text-muted: #8e8bb0;

    --nebula-border-soft: rgba(255, 255, 255, 0.10);
    --nebula-card-bg: rgba(10, 13, 36, 0.98);

    --radius-lg: 22px;
    --radius-md: 18px;
    --radius-sm: 12px;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
      "Segoe UI", sans-serif;
    background:
      radial-gradient(circle at top, #10153c 0, transparent 55%),
      radial-gradient(circle at bottom, #290714 0, transparent 60%),
      linear-gradient(to bottom, var(--nebula-bg-1), var(--nebula-bg-2), var(--nebula-bg-3));
    color: var(--nebula-text-main);
  }

  main {
    max-width: 980px;
    margin: 0 auto;
    padding: 1.25rem 0.9rem 2.5rem;
  }

  /* App shell Hub1 */

  .app-shell {
    border-radius: 24px;
    padding: 0.85rem 0.95rem 0.9rem;
    margin-bottom: 1rem;
    background:
      radial-gradient(circle at top left,
        rgba(255, 119, 233, 0.16),
        rgba(93, 242, 255, 0.08),
        rgba(0, 0, 0, 0.9));
    border: 1px solid rgba(255, 255, 255, 0.16);
    box-shadow: 0 22px 80px rgba(0, 0, 0, 0.85);
  }

  .app-shell-header {
    display: flex;
    align-items: center;
    gap: 0.7rem;
  }

  .app-orb {
    width: 38px;
    height: 38px;
    border-radius: 999px;
    background:
      radial-gradient(circle at 30% 20%, #ffffff, #ffdfff 34%, transparent 60%),
      radial-gradient(circle at 70% 80%, #ff77e9, #5df2ff 70%);
    box-shadow:
      0 0 20px rgba(255, 119, 233, 0.8),
      0 0 32px rgba(93, 242, 255, 0.6);
    position: relative;
    flex-shrink: 0;
  }
  .app-orb::after {
    content: "◎";
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.15rem;
    color: rgba(6, 0, 10, 0.8);
    text-shadow: 0 0 6px rgba(255, 255, 255, 0.9);
  }

  .app-shell-title {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    flex: 1;
    min-width: 0;
  }

  .app-shell-title h1 {
    margin: 0;
    font-size: 1rem;
    letter-spacing: 0.09em;
    text-transform: uppercase;
  }

  .app-shell-title span {
    font-size: 0.82rem;
    color: var(--nebula-text-soft);
  }

  .app-shell-pills {
    margin-top: 0.4rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .app-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.22rem 0.7rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.09em;
    color: var(--nebula-text-soft);
  }
  .app-pill strong {
    color: var(--nebula-accent-cyan);
  }

  /* Tabs (Editor / Analyzer / Injetor) */

  .mode-tabs {
    display: flex;
    gap: 0.4rem;
    margin-top: 0.8rem;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-bottom: 0.2rem;
  }

  .mode-tabs button {
    border: 0;
    border-radius: 999px;
    padding: 0.45rem 0.95rem;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    white-space: nowrap;
    background: rgba(11, 15, 40, 0.95);
    color: var(--nebula-text-soft);
    border: 1px solid rgba(255, 255, 255, 0.12);
    transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.08s ease, color 0.12s ease;
  }

  .mode-tabs button span.badge {
    font-size: 0.7rem;
    padding: 0.1rem 0.45rem;
    border-radius: 999px;
    background: rgba(93, 242, 255, 0.14);
    color: var(--nebula-accent-cyan);
  }

  .mode-tabs button.active {
    background: radial-gradient(circle at top left, #ffe0ff, #ff77e9);
    color: #170315;
    box-shadow: 0 0 18px rgba(255, 119, 233, 0.6);
  }

  .mode-tabs button:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: none;
  }

  /* Cards base */

  .card {
    border-radius: var(--radius-lg);
    padding: 0.95rem 1rem 1rem;
    background:
      radial-gradient(circle at top,
        rgba(93, 242, 255, 0.12) 0%,
        rgba(10, 13, 36, 0.98) 35%,
        rgba(3, 3, 12, 1) 100%);
    border: 1px solid var(--nebula-border-soft);
    box-shadow: 0 20px 70px rgba(0, 0, 0, 0.82);
    margin-top: 0.9rem;
  }

  .card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 0.5rem;
  }

  .card-header-main {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
  }

  .card-header-main h2 {
    margin: 0;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }

  .card-header-main p {
    margin: 0;
    font-size: 0.8rem;
    color: var(--nebula-text-soft);
  }

  .badge-pill {
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--nebula-accent-cyan);
    white-space: nowrap;
  }

  .hint {
    font-size: 0.74rem;
    color: var(--nebula-text-muted);
    margin-top: 0.15rem;
  }

  .field-label-row {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 0.4rem;
    margin-bottom: 0.2rem;
  }

  .field-label-row span {
    font-size: 0.78rem;
    color: var(--nebula-text-soft);
  }

  .field-label-row small {
    font-size: 0.72rem;
    color: var(--nebula-text-muted);
  }

  textarea,
  input[type="text"] {
    width: 100%;
    border-radius: var(--radius-sm);
    border: 1px solid rgba(255, 255, 255, 0.16);
    padding: 0.55rem 0.7rem;
    background: #05000c;
    color: var(--nebula-text-main);
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
      "Liberation Mono", "Courier New", monospace;
    font-size: 0.8rem;
    resize: vertical;
  }

  textarea:focus-visible,
  input[type="text"]:focus-visible {
    outline: 2px solid rgba(93, 242, 255, 0.7);
    outline-offset: 1px;
  }

  .controls-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.55rem;
  }

  button.primary,
  .btn {
    border-radius: 999px;
    border: 0;
    padding: 0.45rem 0.95rem;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;
    background: linear-gradient(135deg,
      var(--nebula-accent-pink),
      var(--nebula-accent-cyan));
    color: #050010;
    box-shadow: 0 10px 26px rgba(0, 0, 0, 0.7);
    white-space: nowrap;
  }

  button.secondary {
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 0.45rem 0.9rem;
    font-size: 0.78rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    background: rgba(12, 15, 40, 0.96);
    color: var(--nebula-text-soft);
  }

  button.ghost {
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    padding: 0.38rem 0.8rem;
    font-size: 0.76rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    background: rgba(4, 5, 18, 0.96);
    color: var(--nebula-text-soft);
  }

  button:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: none;
  }

  .toggle-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.7rem;
    align-items: center;
    margin-top: 0.4rem;
  }

  .toggle-row label {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 0.78rem;
    color: var(--nebula-text-soft);
    cursor: pointer;
  }

  .toggle-row input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--nebula-accent-cyan);
  }

  .grid-vertical {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 0.6rem;
  }

  .preview-frame {
    width: 100%;
    min-height: 280px;
    border-radius: 16px;
    border: 1px solid var(--nebula-border-soft);
    background: #ffffff;
    box-shadow: 0 14px 36px rgba(0, 0, 0, 0.85);
  }

  .small-note {
    font-size: 0.72rem;
    color: var(--nebula-text-muted);
    margin-top: 0.15rem;
  }

  .table-scroll {
    max-height: 260px;
    overflow: auto;
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(5, 7, 22, 0.96);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.78rem;
  }

  th,
  td {
    padding: 0.35rem 0.6rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    text-align: left;
    vertical-align: top;
  }

  th {
    background: rgba(255, 255, 255, 0.04);
    font-weight: 600;
  }

  tr:last-child td {
    border-bottom: none;
  }

  .chips-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    margin-top: 0.4rem;
  }

  .chip {
    border-radius: 999px;
    padding: 0.22rem 0.6rem;
    background: rgba(12, 20, 52, 0.98);
    border: 1px solid rgba(255, 255, 255, 0.18);
    font-size: 0.74rem;
    color: var(--nebula-text-soft);
    white-space: nowrap;
  }

  .chip strong {
    color: var(--nebula-accent-green);
  }

  .pill-warn {
    color: var(--nebula-accent-amber);
    border-color: rgba(255, 181, 108, 0.6);
  }

  .mode-panel {
    display: none;
  }

  .mode-panel.active {
    display: block;
  }

  .radio-row {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    margin-top: 0.35rem;
  }

  .radio-row label {
    font-size: 0.78rem;
    color: var(--nebula-text-soft);
    display: flex;
    align-items: center;
    gap: 0.4rem;
    cursor: pointer;
  }

  .radio-row input[type="radio"] {
    accent-color: var(--nebula-accent-pink);
  }

  .toast {
    position: fixed;
    left: 50%;
    bottom: 16px;
    transform: translateX(-50%);
    padding: 0.5rem 0.85rem;
    border-radius: 999px;
    background: rgba(5, 5, 10, 0.9);
    color: #fff;
    font-size: 0.78rem;
    z-index: 99;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.85);
    pointer-events: none;
  }

  @media (min-width: 840px) {
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.9rem;
      align-items: flex-start;
    }
  }
  </style>

</head>
<body data-theme="nebula" data-stream-bg="default" data-apps-view="rail">
  <div class="shell">
    <header>
      <div class="header-left">
        <button class="menu-button" id="openMenuBtn">≡</button>
        <div class="logo-title">
          <span>Dual.Infodose</span>
          <span>Portal Supremo · Streaming</span>
        </div>
      </div>
      <button class="mode-toggle" id="themeToggleBtn" type="button">
        <div class="mode-dot"></div>
        <span>Modo Nebula / Madeira</span>
      </button>
    </header>

    <!-- HERO · STREAMING DO DIA -->
    <section class="hero-stream">
      <article class="hero-card" id="heroCard">
        <div class="hero-bg" id="heroBg"></div>
        <div class="hero-gradient"></div>

        <div class="hero-content">
          <div class="hero-tag-row">
            <span class="hero-tag" id="heroTag">Streaming do dia</span>
            <div class="hero-mode-pill">
              <span class="dot"></span>
              <span class="label">Portal Supremo ligado</span>
            </div>
          </div>

          <h1 class="hero-title" id="heroTitle">Portal Supremo · Sistema em modo Streaming</h1>
          <p class="hero-subtitle" id="heroSubtitle">
            Um episódio do seu próprio sistema rodando como canal interno.
          </p>

          <div class="hero-actions">
            <button class="btn-primary" id="heroPlayBtn" type="button">
              ▶ Assistir agora
            </button>
            <button class="btn-secondary" id="heroOpenAppBtn" type="button">
              ⧉ Abrir como app
            </button>
            <button class="tts-btn" type="button" title="Ouvir descrição" id="heroTtsBtn">
              ◎
            </button>
          </div>
        </div>
      </article>
    </section>

    <!-- Saudação + intenção -->
    <section class="greeting-strip">
      <div class="greeting-line">
        <span class="greeting-name" id="greetingName">Olá, KODUX</span>
        <span class="time-mini" id="timeMini">Streaming do dia · ready</span>
      </div>
      <div class="intent369-field">
        <span class="intent369-icon">⚡</span>
        <input
          id="intentInput"
          class="intent369-input"
          type="text"
          placeholder="Qual é a intenção do seu Streaming de hoje?"
        />
      </div>
    </section>

    <!-- RAILS · STREAMING POR CATEGORIA -->

        <!-- Trilhas & Ativações (fileira de destaque solta) -->
    <section class="section-title">
      <span>Trilhas & Ativações</span>
      <span>Faixas para abrir o campo.</span>
    </section>
    <section class="rail">
      <div class="rail-track" id="streamRailTrilhas"></div>
    </section>

    <!-- Outras categorias sanfonadas -->

    <section class="video-accordion">
      <details class="stack-card">
        <summary>
          <div class="stack-summary-main">
            <div class="stack-title">Sinopses & Conhecimento</div>
            <div class="stack-sub">Fundamentos da Infodose.</div>
          </div>
          <span class="stack-pill">Vídeos</span>
        </summary>
        <div class="stack-body">
          <section class="rail">
            <div class="rail-track" id="streamRailSinopses"></div>
          </section>
        </div>
      </details>

      <details class="stack-card">
        <summary>
          <div class="stack-summary-main">
            <div class="stack-title">Ambiente & Espaço da Mente</div>
            <div class="stack-sub">Ambientes que conversam com a mente.</div>
          </div>
          <span class="stack-pill">Vídeos</span>
        </summary>
        <div class="stack-body">
          <section class="rail">
            <div class="rail-track" id="streamRailAmbiente"></div>
          </section>
        </div>
      </details>

      <details class="stack-card">
        <summary>
          <div class="stack-summary-main">
            <div class="stack-title">Neurociência & Bem-Estar</div>
            <div class="stack-sub">Dopamina, atenção e cuidado.</div>
          </div>
          <span class="stack-pill">Vídeos</span>
        </summary>
        <div class="stack-body">
          <section class="rail">
            <div class="rail-track" id="streamRailNeuro"></div>
          </section>
        </div>
      </details>

      <details class="stack-card">
        <summary>
          <div class="stack-summary-main">
            <div class="stack-title">Meditações Guiadas</div>
            <div class="stack-sub">Jornadas guiadas pelo Espaço da Mente.</div>
          </div>
          <span class="stack-pill">Vídeos</span>
        </summary>
        <div class="stack-body">
          <section class="rail">
            <div class="rail-track" id="streamRailMeditacoes"></div>
          </section>
        </div>
      </details>
    </section>

    <!-- PORTAL SUPREMO / APPS DO SISTEMA -->

    <section class="section-title with-toggle">
      <div class="section-title-main">
        <span>Portal Supremo / Sistema</span>
        <span>Usando o mesmo viewer e Play Store</span>
      </div>
      <button class="apps-view-toggle" id="appsViewToggleBtn" type="button">
        ▤ Grid
      </button>
    </section>

    <!-- Rail de apps -->
    <section class="rail" id="portalRailSection">
      <div class="rail-track" id="portalRail"></div>
    </section>

    <!-- Grid de apps -->
    <section class="apps-grid-section" id="portalGridSection">
      <div class="apps-grid" id="portalGrid"></div>
    </section>

    <!-- STACKS · PLAY STORE / UPLOAD HTML / CHAT -->
    <section class="apps-stacks">
      <!-- Stack 1: Meus apps / cápsulas -->
      <details class="stack-card" open>
        <summary>
          <div class="stack-summary-main">
            <div class="stack-title">Meus apps / cápsulas</div>
            <div class="stack-sub">
              Salve links, HTMLs e apps para abrir no viewer ou em aba nova.
            </div>
          </div>
          <span class="stack-pill">Play Store Dual</span>
        </summary>
        <div class="stack-body">
          <div class="stack-input-row">
            <div style="flex:1;">
              <div class="stack-field-label">Nome da cápsula</div>
              <input id="capsuleNameInput" class="stack-input" placeholder="Portal Supremo · Sistema" />
            </div>
            <div style="flex:1;">
              <div class="stack-field-label">URL ou caminho do app/HTML</div>
              <input id="capsuleUrlInput" class="stack-input" placeholder="https://..." />
            </div>
          </div>

          <div class="stack-input-row">
            <div style="flex:1;">
              <div class="stack-field-label">Thumb (opcional)</div>
              <input id="capsuleThumbInput" class="stack-input" placeholder="https://imagem.jpg" />
            </div>
            <div style="flex:1;">
              <div class="stack-field-label">Tag / tipo</div>
              <input id="capsuleTagInput" class="stack-input" placeholder="Portal · Streaming · App" />
            </div>
          </div>

          <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
            <button class="pill-btn" id="saveCapsuleBtn" type="button">💾 Salvar cápsula (URL)</button>
            <button class="pill-btn" id="clearCapsulesBtn" type="button">🧹 Limpar tudo</button>
          </div>

          <ul class="capsule-list" id="capsuleList"></ul>

          <div class="stack-footnote">
            Dica: use o botão “Abrir no viewer” para usar o mesmo player do Streaming do dia.
          </div>

          <div class="stack-viewer-card">
            <div class="stack-viewer-header">
              <div>
                <div class="stack-viewer-title">Preview rápido</div>
                <div class="stack-viewer-sub">
                  Visualize apps HTML simples direto aqui.
                </div>
              </div>
              <button class="stack-viewer-reset" id="resetLocalViewerBtn" type="button">
                Limpar preview
              </button>
            </div>
            <div class="stack-viewer-frame" id="localViewerFrame"></div>
            <div class="stack-viewer-note">
              Para visualização mais completa (vídeos, embeds), use o viewer principal lá embaixo.
            </div>
          </div>
        </div>
      </details>

      <!-- Stack 2: Upload HTML / Canal interno -->
      <details class="stack-card">
        <summary>
          <div class="stack-summary-main">
            <div class="stack-title">Upload de HTML local</div>
            <div class="stack-sub">
              Carregue um HTML do seu dispositivo e abra como Streaming interno.
            </div>
          </div>
          <span class="stack-pill">Canal interno</span>
        </summary>
        <div class="stack-body">
          <div class="stack-field-label">HTML (cole o código ou use input file no futuro)</div>
          <textarea
            id="htmlPasteArea"
            class="stack-input"
            style="border-radius:14px;min-height:90px;font-family:monospace;font-size:11px;resize:vertical;padding:8px 10px;"
            placeholder="Cole aqui o HTML que quer testar como canal interno..."
          ></textarea>
          <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
            <button class="pill-btn" id="previewHtmlBtn" type="button">
              ▶ Preview no mini-viewer
            </button>
            <button class="pill-btn" id="openHtmlInViewerBtn" type="button">
              ⧉ Abrir no viewer principal
            </button>
            <button class="pill-btn" id="saveHtmlCapsuleBtn" type="button">
              💾 Salvar HTML como cápsula
            </button>
          </div>
          <div class="stack-footnote">
            Isso reaproveita o mesmo viewer de Streaming do Dia, só que usando o seu HTML local.
          </div>
        </div>
      </details>

      <!-- Stack 3: Painel de Chat / Webhook / OpenRouter -->
      <details class="stack-card">
        <summary>
          <div class="stack-summary-main">
            <div class="stack-title">Chat · Webhook / OpenRouter</div>
            <div class="stack-sub">
              Painel sanfonado para falar com o Blue, webhooks e modelos externos.
            </div>
          </div>
          <span class="stack-pill">Chat Supremo</span>
        </summary>
        <div class="stack-body">
          <div class="chat-config-grid">
            <div class="chat-config-col">
              <div>
                <div class="stack-field-label">Webhook URL (Twilio / Blue / backend)</div>
                <input
                  id="chatWebhookUrlInput"
                  class="stack-input"
                  placeholder="https://seu-servidor.com/webhook"
                />
              </div>
              <div>
                <div class="stack-field-label">Identidade (nome do usuário)</div>
                <input
                  id="chatUserNameInput"
                  class="stack-input"
                  placeholder="Kodux, Blue, etc."
                />
              </div>
            </div>
            <div class="chat-config-col">
              <div>
                <div class="stack-field-label">OpenRouter API Key (opcional)</div>
                <input
                  id="chatOpenRouterKeyInput"
                  class="stack-input"
                  placeholder="sk-or-v1-..."
                />
              </div>
              <div>
                <div class="stack-field-label">Modelo (OpenRouter)</div>
                <input
                  id="chatOpenRouterModelInput"
                  class="stack-input"
                  placeholder="openai/gpt-4.1-mini ou outro"
                />
              </div>
            </div>
          </div>

          <div>
            <div class="stack-field-label">System / Prompt-base do Portal Supremo</div>
            <textarea
              id="chatSystemPromptInput"
              class="chat-textarea"
              placeholder="Cole aqui o prompt-base / Persona que você quer usar no chat..."
            ></textarea>
          </div>

          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:4px;">
            <button class="pill-btn" id="chatSaveConfigBtn" type="button">💾 Salvar configuração</button>
            <button class="pill-btn" id="chatClearConfigBtn" type="button">🧹 Limpar configuração</button>
          </div>

          <div class="chat-panel-card">
            <div class="chat-panel-header">
              <div>
                <div class="chat-panel-title">Canal · Chat Supremo</div>
                <div class="chat-panel-sub" id="chatModeLabel">
                  Esperando mensagem · Webhook se existir, senão OpenRouter
                </div>
              </div>
              <div class="chat-panel-mode-pill" id="chatModePill">
                Auto · Webhook → OpenRouter
              </div>
            </div>

            <div class="chat-messages" id="chatMessages"></div>

            <div class="chat-input-row">
              <input
                id="chatInput"
                class="chat-input"
                placeholder="Digite sua mensagem para o Portal Supremo..."
              />
              <button class="chat-send-btn" id="chatSendBtn" type="button">➤</button>
            </div>
          </div>

          <div class="stack-footnote">
            Lógica: se houver Webhook preenchido, envia primeiro pra ele. Se não houver,
            usa OpenRouter (se API Key + modelo estiverem configurados).
          </div>
        </div>
      </details>
    </section>
  </div>

  <!-- VIEWER PRINCIPAL (STREAMING + APPS) -->
  <div class="view-overlay" id="viewOverlay">
    <div class="view-panel">
      <div class="view-header">
        <button class="view-back" id="viewBackBtn" type="button">✕</button>
        <div class="view-titles">
          <div class="view-title" id="viewTitle">Streaming do dia</div>
          <div class="view-subtitle" id="viewSubtitle">Portal Supremo / Sistema</div>
        </div>
      </div>
      <div class="view-body">
        <div id="viewVideoHolder"></div>
        <p class="view-note" id="viewNote">
          Abrindo com o viewer interno do Portal Supremo. Use este espaço como seu “canal de Streaming do dia”.
        </p>
      </div>
    </div>
  </div>

  <!-- MENU LATERAL BÁSICO -->
  <div class="menu-overlay" id="menuOverlay">
    <div class="menu-panel">
      <div class="menu-top">
        <div class="menu-title">Menu DualOiNet 10</div>
        <button class="menu-close" id="menuCloseBtn" type="button">✕</button>
      </div>

      <div>
        <div class="menu-section-title">modos</div>
        <div class="menu-section">
          <button class="menu-item" id="menuStreamingBtn" type="button">
            Streaming do dia
            <span>Hero + rails de categorias deste arquivo</span>
          </button>
          <button class="menu-item" id="menuPortalBtn" type="button">
            Portal Supremo / Sistema
            <span>Play Store + viewer para apps HTML e canais internos</span>
          </button>
          <button class="menu-item" id="menuChatBtn" type="button">
            Chat Supremo
            <span>Abrir stack de Chat / Webhook / OpenRouter</span>
          </button>
        </div>
      </div>

      <div>
        <div class="menu-section-title">tema</div>
        <div class="menu-section">
          <button class="menu-item" id="menuNebulaBtn" type="button">
            Nebula Pro
            <span>Glow azul/rosa espacial</span>
          </button>
          <button class="menu-item" id="menuMadeiraBtn" type="button">
            Base Madeira
            <span>Tom amadeirado quente · modo KOBLLUX</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // HELPERS · YOUTUBE + PLAYLIST
    // ============================

    function categoryToBg(cat){
      switch(cat){
        case "Trilhas e Ativações": return "deep";
        case "Sinopses": return "warm";
        case "Ambiente e Espaço da Mente": return "cool";
        case "Neurociência e Bem-Estar": return "deep";
        case "Meditações Guiadas": return "cool";
        default: return "default";
      }
    }

    function ytVideo({id, title, subtitle, tag, category, bgMode}){
      return {
        id,
        title,
        subtitle,
        tag: tag || category,
        category,
        thumb: `https://img.youtube.com/vi/${id}/hqdefault.jpg`,
        heroImg: `https://img.youtube.com/vi/${id}/maxresdefault.jpg`,
        embedUrl: `https://www.youtube.com/embed/${id}`,
        bgMode: bgMode || categoryToBg(category),
        kind: "youtube"
      };
    }

    function ytPlaylist({listId, title, subtitle, tag, category, bgMode, thumbVideoId}){
      return {
        id: listId,
        title,
        subtitle,
        tag: tag || "Playlist",
        category,
        thumb: thumbVideoId
          ? `https://img.youtube.com/vi/${thumbVideoId}/hqdefault.jpg`
          : "",
        heroImg: thumbVideoId
          ? `https://img.youtube.com/vi/${thumbVideoId}/maxresdefault.jpg`
          : "",
        embedUrl: `https://www.youtube.com/embed/videoseries?list=${listId}`,
        bgMode: bgMode || categoryToBg(category),
        kind: "youtube-playlist"
      };
    }

    // ============================
    // DADOS · STREAMING DO DIA (seus vídeos)
    // ============================

    const streamingItems = [
      // Trilhas e Ativações
      ytVideo({
        id: "Bt_rLbMjJDk",
        title: "Trilhas Potencializadoras dos Aromas",
        subtitle: "Ative aromas, memórias e intenção no mesmo fluxo.",
        tag: "Trilhas",
        category: "Trilhas e Ativações"
      }),
      ytVideo({
        id: "_0wVkryxanE",
        title: "Desperte a magia dos 12 arquétipos",
        subtitle: "Introdução viva à magia arquetípica da Infodose.",
        tag: "Arquétipos",
        category: "Trilhas e Ativações"
      }),
      ytVideo({
        id: "Id2NI9tv1r4",
        title: "Infodose – Pra quem merece saber",
        subtitle: "Se chegou até aqui, é porque você merece.",
        tag: "Infodose",
        category: "Trilhas e Ativações"
      }),
      ytPlaylist({
        listId: "PL_XiIUPFx4DSKFuJZZiKCxVUy20PtDdaB",
        title: "Infodose – Se chegou até você merece saber (Playlist)",
        subtitle: "Série completa para manter o campo ativo.",
        tag: "Playlist",
        category: "Trilhas e Ativações",
        thumbVideoId: "Id2NI9tv1r4"
      }),

      // Sinopses e Conhecimentos Fundamentais
      ytVideo({
        id: "qldgs0aLdB0",
        title: "Sinopse – A Fórmula da Dopamina Sexy",
        subtitle: "Entenda a base da dopamina aplicada à criação.",
        tag: "Sinopse",
        category: "Sinopses"
      }),
      ytVideo({
        id: "FbutKMpd8MY",
        title: "Sinopse – O Espaço da Mente",
        subtitle: "O lugar onde tudo acontece antes de acontecer.",
        tag: "Sinopse",
        category: "Sinopses"
      }),
      ytVideo({
        id: "1L9_rFmIGJ8",
        title: "Sinopse – A Recompensa",
        subtitle: "Por que seu cérebro busca tanto a recompensa?",
        tag: "Sinopse",
        category: "Sinopses"
      }),
      ytPlaylist({
        listId: "PL_XiIUPFx4DQam6tyiwimO5b3X_T1Y1wd",
        title: "Sinopse dos Livros – Espaço da Mente & Dopamina Sexy",
        subtitle: "Playlist unindo os dois pilares da Infodose.",
        tag: "Playlist",
        category: "Sinopses",
        thumbVideoId: "qldgs0aLdB0"
      }),

      // Ambiente e Espaço da Mente
      ytVideo({
        id: "koKhjQKGJSc",
        title: "Manipulação da energia – O poder das cortinas",
        subtitle: "Como um detalhe muda a energia do ambiente.",
        tag: "Ambiente",
        category: "Ambiente e Espaço da Mente"
      }),
      ytVideo({
        id: "KrtOVrk8aDk",
        title: "Poder sob seus pés – Pisos criam fluxos de energia",
        subtitle: "Sua base física também é base energética.",
        tag: "Ambiente",
        category: "Ambiente e Espaço da Mente"
      }),

      // Neurociência e Bem-Estar
      ytVideo({
        id: "NBWDV6xjUP0",
        title: "Dopamina – O segredo que não te contaram sobre vícios",
        subtitle: "A mecânica real da dopamina além dos clichês.",
        tag: "Neurociência",
        category: "Neurociência e Bem-Estar"
      }),
      ytVideo({
        id: "dGYbN8jgdNQ",
        title: "TDAH e Dopamina – A verdade está aqui",
        subtitle: "Reenquadrando atenção, foco e dopamina.",
        tag: "Neurociência",
        category: "Neurociência e Bem-Estar"
      }),
      ytVideo({
        id: "JBjFhAutIVk",
        title: "Como manipular seu subconsciente",
        subtitle: "Ferramentas práticas para reprogramar padrões.",
        tag: "Subconsciente",
        category: "Neurociência e Bem-Estar"
      }),
      ytVideo({
        id: "GSBv45vigRE",
        title: "Esquece das coisas? Entenda o real motivador disso tudo",
        subtitle: "Esquecimento, fuga e o que está por trás disso.",
        tag: "Neurociência",
        category: "Neurociência e Bem-Estar"
      }),

      // Meditações Guiadas
      ytVideo({
        id: "hfQ1L6fCfAo",
        title: "Meditação Guiada – À deriva no espaço da mente",
        subtitle: "Soltar o corpo e viajar pelo espaço interno.",
        tag: "Meditação",
        category: "Meditações Guiadas"
      }),
      ytVideo({
        id: "Tq99vQNQ6dQ",
        title: "Meditação Guiada – À deriva na mente do espaço da mente",
        subtitle: "Camada meta do espaço da mente.",
        tag: "Meditação",
        category: "Meditações Guiadas"
      }),
      ytVideo({
        id: "DTDfkHwuMic",
        title: "Meditação Guiada – Navegando pelo Universo da Mente",
        subtitle: "Exploração profunda em múltiplos espaços internos.",
        tag: "Meditação",
        category: "Meditações Guiadas"
      }),
      ytVideo({
        id: "OVfqxW_Xlhw",
        title: "Meditação Guiada – Sinfonia da Expansão Criativa",
        subtitle: "Ativação criativa em estado meditativo.",
        tag: "Meditação",
        category: "Meditações Guiadas"
      }),
      ytVideo({
        id: "kCHvLOtJIwQ",
        title: "Meditação Guiada – Uma Jornada de Transformação",
        subtitle: "Percurso guiado de mudança interna.",
        tag: "Meditação",
        category: "Meditações Guiadas"
      })
    ];

    // ============================
    // PLAY STORE · APPS DO SISTEMA
    // ============================

    const playStoreApps = [
      {
        key: "Orc",
        title: "🗒️ CostaRibeiro-Orc",
        desc: "PWA offline com dashboard, lembrete e relat.",
        icon: "icons/icon-180.png",
        url: "./apps/CostaRibeiro-ORc.html"
      },
      {
        key: "catcr",
        title: "CATCR",
        desc: "Regularize seu .",
        icon: "icons/icon-181.png",
        url: "./apps/CATCR.html"
      },
      {
        key: "catalogos-orc",
        title: "📑 Catálogos (Orçamentos)",
        desc: "Gere orçamentos.",
        icon: "icons/icon-182.png",
        url: "./apps/CostaRibero-Cotar0.html"
      },
      {
        key: "catalogos-geral",
        title: "📑 Catálogos",
        desc: "Gere catálogos.",
        icon: "icons/icon-192.png",
        url: "./apps/CatCostaRibeiro.html"
      },
      {
        key: "d0x",
        title: "📜 infoD0X",
        desc: "Livro vivo.",
        icon: "icons/icon-d0x.png",
        url: "./apps/index_final_cards_nossolar.html"
      },
      {
        key: "ticos",
        title: "🗒️ Práticas — NR10/NR35 (Ultra)",
        desc: "PWA offline com dashboard, lembrete e relatos com áudio.",
        icon: "icons/icon-192.png",
        url: "./PWA_TICO_Ultra/index.html"
      },
      {
        key: "reg-imovel",
        title: "🏠 Regularização",
        desc: "Regularize seu imóvel.",
        icon: "icons/icon-192.png",
        url: "./apps/lp-reg-10-ok-R-5.html"
      },
      {
        key: "contratos",
        title: "📑 Gerar Contrato",
        desc: "Gere contratos.",
        icon: "icons/icon-192.png",
        url: "./apps/JHBARROS-contratos.html"
      },
      {
        key: "d0x-2",
        title: "📜 infoD0X (alt)",
        desc: "Livro vivo (variação).",
        icon: "icons/icon-192.png",
        url: "./apps/index_final_cards_nossolar.html"
      },
      {
        key: "dual-editor",
        title: "✏️ Dual Editor • Kodux",
        desc: "Editor vivo para códigos, prompts e HTML Dual.",
        icon: "icons/icon-192.png",
        url: "https://kodux78k.github.io/Dual-Editor/"
      },
      {
        key: "unouno-oraculo",
        title: "🌀 UnoUno • Oráculo Dual",
        desc: "Oráculo simbólico estilo HUB Uno, experimental.",
        icon: "icons/icon-192.png",
        url: "https://kodux78k.github.io/Unouno-/index.html"
      },
      {
        key: "info-doc",
        title: "📚 Info-Doc • Livro Vivo",
        desc: "Leitor/organizador de documentos e livros vivos Infodose.",
        icon: "icons/icon-192.png",
        url: "https://kodux78k.github.io/info-Doc/index.html"
      },
      {
        key: "nossolar-dual",
        title: "☀️ Nos.S°lar – dual.infodose",
        desc: "Painel solar simbólico com cards e rede Nos.S°lar.",
        icon: "icons/icon-192.png",
        url: "https://kodux78k.github.io/NosSolar-dualInfodose/",
        featured: true
      },
      {
        key: "dual-app",
        title: "🌐 Dual App • Hub",
        desc: "App central Dual para experimentos de interface e fluxo.",
        icon: "icons/icon-192.png",
        url: "https://kodux78k.github.io/dual-app/index.html"
      },
      {
        key: "dual-splash",
        title: "✨ A.Dual.Infodose • Splash",
        desc: "Tela de abertura / splash ritual da A.Dual.Infodose.",
        icon: "icons/icon-192.png",
        url: "https://kodux78k.github.io/A.Dual.Infodose/splash.html"
      }
    ];

    const FEATURED_APP_KEY = "nossolar-dual";
    const featuredApp =
      playStoreApps.find(a => a.key === FEATURED_APP_KEY) || playStoreApps[0];

    // ============================
    // ELEMENTOS
    // ============================

    const heroCard = document.getElementById("heroCard");
    const heroBg = document.getElementById("heroBg");
    const heroTag = document.getElementById("heroTag");
    const heroTitle = document.getElementById("heroTitle");
    const heroSubtitle = document.getElementById("heroSubtitle");
    const heroPlayBtn = document.getElementById("heroPlayBtn");
    const heroOpenAppBtn = document.getElementById("heroOpenAppBtn");
    const heroTtsBtn = document.getElementById("heroTtsBtn");

    const viewOverlay = document.getElementById("viewOverlay");
    const viewBackBtn = document.getElementById("viewBackBtn");
    const viewTitle = document.getElementById("viewTitle");
    const viewSubtitle = document.getElementById("viewSubtitle");
    const viewVideoHolder = document.getElementById("viewVideoHolder");
    const viewNote = document.getElementById("viewNote");

    const greetingName = document.getElementById("greetingName");
    const timeMini = document.getElementById("timeMini");
    const intentInput = document.getElementById("intentInput");

    const capsuleNameInput = document.getElementById("capsuleNameInput");
    const capsuleUrlInput = document.getElementById("capsuleUrlInput");
    const capsuleThumbInput = document.getElementById("capsuleThumbInput");
    const capsuleTagInput = document.getElementById("capsuleTagInput");
    const saveCapsuleBtn = document.getElementById("saveCapsuleBtn");
    const clearCapsulesBtn = document.getElementById("clearCapsulesBtn");
    const capsuleListEl = document.getElementById("capsuleList");
    const localViewerFrame = document.getElementById("localViewerFrame");
    const resetLocalViewerBtn = document.getElementById("resetLocalViewerBtn");

    const htmlPasteArea = document.getElementById("htmlPasteArea");
    const previewHtmlBtn = document.getElementById("previewHtmlBtn");
    const openHtmlInViewerBtn = document.getElementById("openHtmlInViewerBtn");
    const saveHtmlCapsuleBtn = document.getElementById("saveHtmlCapsuleBtn");

    const themeToggleBtn = document.getElementById("themeToggleBtn");

    const openMenuBtn = document.getElementById("openMenuBtn");
    const menuOverlay = document.getElementById("menuOverlay");
    const menuCloseBtn = document.getElementById("menuCloseBtn");
    const menuStreamingBtn = document.getElementById("menuStreamingBtn");
    const menuPortalBtn = document.getElementById("menuPortalBtn");
    const menuChatBtn = document.getElementById("menuChatBtn");
    const menuNebulaBtn = document.getElementById("menuNebulaBtn");
    const menuMadeiraBtn = document.getElementById("menuMadeiraBtn");

    const appsViewToggleBtn = document.getElementById("appsViewToggleBtn");
    const portalRail = document.getElementById("portalRail");
    const portalGrid = document.getElementById("portalGrid");

    // Chat elements
    const chatWebhookUrlInput = document.getElementById("chatWebhookUrlInput");
    const chatUserNameInput = document.getElementById("chatUserNameInput");
    const chatOpenRouterKeyInput = document.getElementById("chatOpenRouterKeyInput");
    const chatOpenRouterModelInput = document.getElementById("chatOpenRouterModelInput");
    const chatSystemPromptInput = document.getElementById("chatSystemPromptInput");
    const chatSaveConfigBtn = document.getElementById("chatSaveConfigBtn");
    const chatClearConfigBtn = document.getElementById("chatClearConfigBtn");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatInputEl = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const chatModeLabel = document.getElementById("chatModeLabel");
    const chatModePill = document.getElementById("chatModePill");

    // ============================
    // FUNÇÕES AUXILIARES
    // ============================

    function formatTimeMini(){
      const now = new Date();
      const h = String(now.getHours()).padStart(2,"0");
      const m = String(now.getMinutes()).padStart(2,"0");
      return `${h}:${m} · modo Streaming`;
    }

    function applyBgTheme(bgMode){
      const mode = bgMode || "default";
      document.body.setAttribute("data-stream-bg", mode);
    }

    function applyHeroFromItem(item){
      if(!item) return;
      heroTag.textContent = item.tag || "Streaming";
      heroTitle.textContent = item.title;
      heroSubtitle.textContent = item.subtitle || "";
      document.documentElement.style.setProperty(
        "--hero-img-url",
        `url("${item.heroImg || item.thumb}")`
      );
      applyBgTheme(item.bgMode);
    }

    function openInViewer({title, subtitle, url, note}){
      viewTitle.textContent = title || "Viewer interno";
      viewSubtitle.textContent = subtitle || "";
      viewNote.textContent = note || "Abrindo com o viewer interno.";
      viewVideoHolder.innerHTML = "";

      if(url){
        const iframe = document.createElement("iframe");
        iframe.src = url;
        iframe.allow =
          "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
        iframe.allowFullscreen = true;
        viewVideoHolder.appendChild(iframe);
      }

      viewOverlay.classList.add("visible");
    }

    function closeViewer(){
      viewOverlay.classList.remove("visible");
      viewVideoHolder.innerHTML = "";
    }

    // ============================
    // RENDER · STREAMING POR CATEGORIA
    // ============================

    function createStreamCard(item){
      const card = document.createElement("article");
      card.className = "stream-card";
      card.dataset.streamId = item.id;

      const thumb = document.createElement("div");
      thumb.className = "stream-thumb";
      if(item.thumb){
        thumb.style.backgroundImage = `url("${item.thumb}")`;
      }

      const inner = document.createElement("div");
      inner.className = "stream-inner";

      const tag = document.createElement("div");
      tag.className = "stream-tag";
      tag.textContent = item.tag || "Streaming";

      const ttsBtn = document.createElement("button");
      ttsBtn.className = "tts-btn stream-tts";
      ttsBtn.type = "button";
      ttsBtn.textContent = "◎";
      ttsBtn.title = "Ouvir título";

      const title = document.createElement("div");
      title.className = "stream-title";
      title.textContent = item.title;

      const sub = document.createElement("div");
      sub.className = "stream-sub";
      sub.textContent = item.subtitle || "";

      inner.appendChild(title);
      inner.appendChild(sub);

      card.appendChild(thumb);
      card.appendChild(inner);
      card.appendChild(tag);
      card.appendChild(ttsBtn);

      card.addEventListener("click", () => {
        applyHeroFromItem(item);
        openInViewer({
          title: item.title,
          subtitle: item.subtitle,
          url: item.embedUrl,
          note: "Streaming do dia rodando no viewer interno."
        });
      });

      ttsBtn.addEventListener("click", ev => {
        ev.stopPropagation();
        if("speechSynthesis" in window){
          const u = new SpeechSynthesisUtterance(
            `${item.title}. ${item.subtitle || ""}`
          );
          u.lang = "pt-BR";
          window.speechSynthesis.speak(u);
        }
      });

      return card;
    }

    function renderStreamingRails(){
      const railsConfig = [
        {
          id: "streamRailTrilhas",
          categories: ["Trilhas e Ativações"]
        },
        {
          id: "streamRailSinopses",
          categories: ["Sinopses"]
        },
        {
          id: "streamRailAmbiente",
          categories: ["Ambiente e Espaço da Mente"]
        },
        {
          id: "streamRailNeuro",
          categories: ["Neurociência e Bem-Estar"]
        },
        {
          id: "streamRailMeditacoes",
          categories: ["Meditações Guiadas"]
        }
      ];

      railsConfig.forEach(cfg => {
        const track = document.getElementById(cfg.id);
        if(!track) return;
        track.innerHTML = "";

        const list = streamingItems.filter(item =>
          cfg.categories.includes(item.category)
        );

        if(!list.length){
          const emptyMsg = document.createElement("div");
          emptyMsg.style.fontSize = "11px";
          emptyMsg.style.color = "var(--text-muted)";
          emptyMsg.style.padding = "8px 2px";
          emptyMsg.textContent = "Sem vídeos nessa categoria ainda.";
          track.appendChild(emptyMsg);
          return;
        }

        list.forEach(item => {
          track.appendChild(createStreamCard(item));
        });
      });
    }

    // ============================
    // APP GROUPS · PARA GRADIENT
    // ============================

    function getAppGroup(app){
      const k = (app.key || "").toLowerCase();
      const t = (app.title || "").toLowerCase();

      if(k.includes("dual") || k.includes("unouno") || t.includes("dual")){
        return "dual";
      }
      if(k.includes("solar") || t.includes("solar") || t.includes("nos.s°lar")){
        return "solar";
      }
      if(k.includes("d0x") || k.includes("info") || t.includes("livro")){
        return "docs";
      }
      return "base";
    }

    // ============================
    // RENDER · PORTAL SUPREMO (apps)
    // ============================

    function createAppCard(app){
      const card = document.createElement("article");
      card.className = "stream-card app-card";
      card.dataset.portalId = app.key;
      card.dataset.appGroup = getAppGroup(app);

      const thumb = document.createElement("div");
      thumb.className = "stream-thumb";
      if(app.icon){
        thumb.style.backgroundImage = `url("${app.icon}")`;
      }

      const inner = document.createElement("div");
      inner.className = "stream-inner";

      const tag = document.createElement("div");
      tag.className = "stream-tag";
      tag.textContent = "App";

      const title = document.createElement("div");
      title.className = "stream-title";
      title.textContent = app.title;

      const sub = document.createElement("div");
      sub.className = "stream-sub";
      sub.textContent = app.desc || "";

      inner.appendChild(title);
      inner.appendChild(sub);

      card.appendChild(thumb);
      card.appendChild(inner);
      card.appendChild(tag);

      card.addEventListener("click", () => {
        applyBgTheme("deep");
        openInViewer({
          title: app.title,
          subtitle: app.desc || "",
          url: app.url,
          note: "App do Portal Supremo rodando no viewer (Play Store interna)."
        });
      });

      return card;
    }

    function renderPortalApps(){
      portalRail.innerHTML = "";
      portalGrid.innerHTML = "";
      playStoreApps.forEach(app => {
        const cardRail = createAppCard(app);
        portalRail.appendChild(cardRail);

        const cardGrid = createAppCard(app);
        portalGrid.appendChild(cardGrid);
      });
    }

    // ============================
    // PLAY STORE / CÁPSULAS (locais)
    // ============================

    const CAPSULE_KEY = "dual_portal_stream_capsules_v1";

    function loadCapsules(){
      try{
        const raw = localStorage.getItem(CAPSULE_KEY);
        if(!raw) return [];
        return JSON.parse(raw);
      }catch(e){
        return [];
      }
    }

    function saveCapsules(caps){
      localStorage.setItem(CAPSULE_KEY, JSON.stringify(caps));
    }

    function renderCapsules(){
      const caps = loadCapsules();
      capsuleListEl.innerHTML = "";
      if(!caps.length){
        const empty = document.createElement("li");
        empty.className = "capsule-pill";
        empty.innerHTML =
          '<div class="capsule-main"><div class="capsule-title">Nenhuma cápsula salva ainda</div><div class="capsule-tag">Salve um link ou HTML para começar.</div></div>';
        capsuleListEl.appendChild(empty);
        return;
      }

      caps.forEach((cap, index) => {
        const li = document.createElement("li");
        li.className = "capsule-pill";

        const main = document.createElement("div");
        main.className = "capsule-main";

        const title = document.createElement("div");
        title.className = "capsule-title";
        title.textContent = cap.name || "(sem nome)";

        const isHtml = !!cap.html || cap.isHtml;
        const tag = document.createElement("div");
        tag.className = "capsule-tag";
        tag.textContent = cap.tag
          ? cap.tag + (isHtml ? " · HTML" : "")
          : isHtml
          ? "HTML interno"
          : cap.url || "";

        main.appendChild(title);
        main.appendChild(tag);

        const actions = document.createElement("div");
        actions.className = "capsule-actions";

        const btnViewer = document.createElement("button");
        btnViewer.className = "pill-btn";
        btnViewer.type = "button";
        btnViewer.textContent = "▶ Abrir no viewer";
        btnViewer.addEventListener("click", () => {
          applyBgTheme("deep");
          openInViewer({
            title: cap.name || "Cápsula",
            subtitle: cap.tag || "",
            url: isHtml ? "about:blank" : cap.url,
            note: isHtml
              ? "HTML interno sendo renderizado pelo viewer."
              : "Cápsula da Play Store interna usando o viewer do Portal."
          });

          if(isHtml){
            const iframe = viewVideoHolder.querySelector("iframe");
            if(iframe){
              iframe.addEventListener("load", () => {
                iframe.contentWindow.document.open();
                iframe.contentWindow.document.write(cap.html || "");
                iframe.contentWindow.document.close();
              });
            }
          }
        });

        const btnPreview = document.createElement("button");
        btnPreview.className = "pill-btn";
        btnPreview.type = "button";
        btnPreview.textContent = "⧉ Preview local";
        btnPreview.addEventListener("click", () => {
          if(isHtml && cap.html){
            localViewerFrame.innerHTML = cap.html;
          }else if(cap.url){
            localViewerFrame.innerHTML =
              `<iframe src="${cap.url}" style="width:100%;height:100%;border:0;border-radius:0 0 18px 18px;"></iframe>`;
          }
        });

        const btnRemove = document.createElement("button");
        btnRemove.className = "pill-btn";
        btnRemove.type = "button";
        btnRemove.textContent = "🗑 Remover";
        btnRemove.addEventListener("click", () => {
          const updated = loadCapsules().filter((_, i) => i !== index);
          saveCapsules(updated);
          renderCapsules();
        });

        actions.appendChild(btnViewer);
        actions.appendChild(btnPreview);
        actions.appendChild(btnRemove);

        li.appendChild(main);
        li.appendChild(actions);

        capsuleListEl.appendChild(li);
      });
    }

    saveCapsuleBtn.addEventListener("click", () => {
      const name = capsuleNameInput.value.trim();
      const url = capsuleUrlInput.value.trim();
      const thumb = capsuleThumbInput.value.trim();
      const tag = capsuleTagInput.value.trim();

      if(!url){
        alert("Precisa pelo menos de uma URL.");
        return;
      }

      const caps = loadCapsules();
      caps.unshift({name, url, thumb, tag, isHtml:false});
      saveCapsules(caps);
      renderCapsules();

      capsuleNameInput.value = "";
      capsuleUrlInput.value = "";
      capsuleThumbInput.value = "";
      capsuleTagInput.value = "";
    });

    clearCapsulesBtn.addEventListener("click", () => {
      if(confirm("Apagar todas as cápsulas salvas?")){
        localStorage.removeItem(CAPSULE_KEY);
        renderCapsules();
      }
    });

    resetLocalViewerBtn.addEventListener("click", () => {
      localViewerFrame.innerHTML = "";
    });

    // HTML colado
    previewHtmlBtn.addEventListener("click", () => {
      const html = htmlPasteArea.value.trim();
      if(!html){
        alert("Cole algum HTML primeiro.");
        return;
      }
      localViewerFrame.innerHTML = html;
    });

    openHtmlInViewerBtn.addEventListener("click", () => {
      const html = htmlPasteArea.value.trim();
      if(!html){
        alert("Cole algum HTML primeiro.");
        return;
      }
      openInViewer({
        title: "HTML local",
        subtitle: "Conteúdo colado sendo exibido pelo viewer interno.",
        url: "about:blank",
        note: "HTML colado sendo renderizado diretamente dentro do viewer."
      });
      const iframe = viewVideoHolder.querySelector("iframe");
      if(iframe){
        iframe.addEventListener("load", () => {
          iframe.contentWindow.document.open();
          iframe.contentWindow.document.write(html);
          iframe.contentWindow.document.close();
        });
      }
    });

    // Salvar HTML como cápsula
    saveHtmlCapsuleBtn.addEventListener("click", () => {
      const html = htmlPasteArea.value.trim();
      if(!html){
        alert("Cole algum HTML primeiro para salvar.");
        return;
      }
      const name = capsuleNameInput.value.trim() || "Canal interno HTML";
      const tag = capsuleTagInput.value.trim() || "HTML interno";

      const caps = loadCapsules();
      caps.unshift({
        name,
        url: "",
        html,
        tag,
        isHtml: true
      });
      saveCapsules(caps);
      renderCapsules();
    });

    // ============================
    // CHAT SUPREMO · STATE + CONFIG
    // ============================

    const CHAT_CFG_KEY = "dual_portal_chat_config_v1";

    function loadChatConfig(){
      try{
        const raw = localStorage.getItem(CHAT_CFG_KEY);
        if(!raw) return {};
        return JSON.parse(raw);
      }catch(e){
        return {};
      }
    }

    function saveChatConfig(cfg){
      localStorage.setItem(CHAT_CFG_KEY, JSON.stringify(cfg));
    }

    function refreshChatModeLabel(cfg){
      const hasWebhook = !!cfg.webhookUrl;
      const hasOR = !!cfg.openRouterKey && !!cfg.openRouterModel;
      let label = "Sem destino configurado ainda.";
      let pill = "Modo ocioso";

      if(hasWebhook && hasOR){
        label = "Envia primeiro para Webhook · fallback OpenRouter.";
        pill = "Webhook → OpenRouter";
      }else if(hasWebhook){
        label = "Enviando mensagens apenas para seu Webhook.";
        pill = "Somente Webhook";
      }else if(hasOR){
        label = "Enviando mensagens apenas para OpenRouter.";
        pill = "Somente OpenRouter";
      }

      chatModeLabel.textContent = label;
      chatModePill.textContent = pill;
    }

    function applyChatConfigToInputs(cfg){
      chatWebhookUrlInput.value = cfg.webhookUrl || "";
      chatUserNameInput.value = cfg.userName || "";
      chatOpenRouterKeyInput.value = cfg.openRouterKey || "";
      chatOpenRouterModelInput.value = cfg.openRouterModel || "";
      chatSystemPromptInput.value = cfg.systemPrompt || "";
      refreshChatModeLabel(cfg);
    }

    const chatConfigInitial = loadChatConfig();
    applyChatConfigToInputs(chatConfigInitial);

    chatSaveConfigBtn.addEventListener("click", () => {
      const cfg = {
        webhookUrl: chatWebhookUrlInput.value.trim(),
        userName: chatUserNameInput.value.trim(),
        openRouterKey: chatOpenRouterKeyInput.value.trim(),
        openRouterModel: chatOpenRouterModelInput.value.trim(),
        systemPrompt: chatSystemPromptInput.value.trim()
      };
      saveChatConfig(cfg);
      refreshChatModeLabel(cfg);
      alert("Configuração de chat salva.");
    });

    chatClearConfigBtn.addEventListener("click", () => {
      if(!confirm("Limpar configuração de chat (Webhook / OpenRouter / Prompt)?")) return;
      localStorage.removeItem(CHAT_CFG_KEY);
      applyChatConfigToInputs({});
    });

    // ============================
    // CHAT SUPREMO · MENSAGENS
    // ============================

    const chatMessages = [];

    function renderChatMessages(){
      chatMessagesEl.innerHTML = "";
      chatMessages.forEach(msg => {
        const div = document.createElement("div");
        div.className = "chat-message " + msg.role;
        div.textContent = msg.text;
        chatMessagesEl.appendChild(div);
      });
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function pushChatMessage(role, text){
      chatMessages.push({role, text});
      renderChatMessages();
    }

    async function sendChat(){
      const text = chatInputEl.value.trim();
      if(!text) return;

      const cfg = loadChatConfig();
      const {webhookUrl, openRouterKey, openRouterModel, systemPrompt, userName} = cfg;

      pushChatMessage("me", text);
      chatInputEl.value = "";

      let used = null;
      let reply = "";

      try{
        if(webhookUrl){
          used = "webhook";
          const payload = {
            sender: userName || "Kodux",
            message: text,
            system: systemPrompt || "",
            source: "DualOiNet-10"
          };

          const res = await fetch(webhookUrl, {
            method:"POST",
            headers:{
              "Content-Type":"application/json"
            },
            body:JSON.stringify(payload)
          });

          if(!res.ok){
            throw new Error("Status " + res.status);
          }

          const data = await res.json().catch(() => ({}));
          reply =
            data.reply ||
            data.response ||
            data.message ||
            data.content ||
            JSON.stringify(data).slice(0,400);
        }else if(openRouterKey && openRouterModel){
          used = "openrouter";
          const body = {
            model: openRouterModel,
            messages: [
              systemPrompt
                ? {role:"system", content:systemPrompt}
                : null,
              {
                role:"user",
                content: (userName ? userName + ": " : "") + text
              }
            ].filter(Boolean)
          };

          const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "Authorization":"Bearer " + openRouterKey
            },
            body:JSON.stringify(body)
          });

          if(!res.ok){
            throw new Error("Status " + res.status);
          }

          const data = await res.json();
          reply =
            data.choices?.[0]?.message?.content?.trim() ||
            "[Sem conteúdo de resposta do modelo]";
        }else{
          used = "none";
          reply =
            "Nenhum destino configurado.\n" +
            "Preencha o Webhook ou a API Key + Modelo do OpenRouter em cima para ativar o Chat Supremo.";
        }
      }catch(err){
        reply = "Erro ao buscar resposta (" + (used || "indefinido") + "): " + err.message;
      }

      pushChatMessage("ai", reply);
    }

    chatSendBtn.addEventListener("click", sendChat);
    chatInputEl.addEventListener("keydown", ev => {
      if(ev.key === "Enter" && !ev.shiftKey){
        ev.preventDefault();
        sendChat();
      }
    });

    // ============================
    // TEMA E MENU
    // ============================

    function setTheme(theme){
      document.body.setAttribute("data-theme", theme);
      localStorage.setItem("dual_portal_theme", theme);
    }

    function toggleTheme(){
      const current = document.body.getAttribute("data-theme") || "nebula";
      setTheme(current === "nebula" ? "madeira" : "nebula");
    }

    themeToggleBtn.addEventListener("click", toggleTheme);

    const savedTheme = localStorage.getItem("dual_portal_theme");
    if(savedTheme){
      setTheme(savedTheme);
    }

    openMenuBtn.addEventListener("click", () => {
      menuOverlay.classList.add("visible");
    });
    menuCloseBtn.addEventListener("click", () => {
      menuOverlay.classList.remove("visible");
    });
    menuOverlay.addEventListener("click", e => {
      if(e.target === menuOverlay){
        menuOverlay.classList.remove("visible");
      }
    });

    menuStreamingBtn.addEventListener("click", () => {
      menuOverlay.classList.remove("visible");
      window.scrollTo({top:0,behavior:"smooth"});
    });

    menuPortalBtn.addEventListener("click", () => {
      menuOverlay.classList.remove("visible");
      const appsStacks = document.querySelector(".apps-stacks");
      if(appsStacks){
        const rect = appsStacks.getBoundingClientRect();
        const offset = window.scrollY + rect.top - 40;
        window.scrollTo({top:offset,behavior:"smooth"});
      }
    });

    menuChatBtn.addEventListener("click", () => {
      menuOverlay.classList.remove("visible");
      const stacks = document.querySelectorAll(".apps-stacks details.stack-card");
      const chatStack = stacks[2]; // terceiro stack (Chat Supremo)
      if(chatStack){
        chatStack.open = true;
        const rect = chatStack.getBoundingClientRect();
        const offset = window.scrollY + rect.top - 40;
        window.scrollTo({top:offset,behavior:"smooth"});
      }
    });

    menuNebulaBtn.addEventListener("click", () => setTheme("nebula"));
    menuMadeiraBtn.addEventListener("click", () => setTheme("madeira"));

    // ============================
    // HERO / VIEWER
    // ============================

    heroCard.addEventListener("click", () => {
      const first = streamingItems[0];
      if(!first) return;
      applyHeroFromItem(first);
      openInViewer({
        title: first.title,
        subtitle: first.subtitle,
        url: first.embedUrl,
        note: "Streaming do dia rodando no viewer interno."
      });
    });

    heroPlayBtn.addEventListener("click", e => {
      e.stopPropagation();
      const first = streamingItems[0];
      if(!first) return;
      applyHeroFromItem(first);
      openInViewer({
        title: first.title,
        subtitle: first.subtitle,
        url: first.embedUrl,
        note: "Streaming do dia rodando no viewer interno."
      });
    });

    heroOpenAppBtn.addEventListener("click", e => {
      e.stopPropagation();
      if(!featuredApp) return;
      openInViewer({
        title: featuredApp.title,
        subtitle: featuredApp.desc || "",
        url: featuredApp.url,
        note: "App destaque (cápsula destacada) rodando como Streaming automático do dia."
      });
    });

    heroTtsBtn.addEventListener("click", e => {
      e.stopPropagation();
      if("speechSynthesis" in window){
        const u = new SpeechSynthesisUtterance(
          `${heroTitle.textContent}. ${heroSubtitle.textContent || ""}`
        );
        u.lang = "pt-BR";
        window.speechSynthesis.speak(u);
      }
    });

    viewBackBtn.addEventListener("click", closeViewer);
    viewOverlay.addEventListener("click", e => {
      if(e.target === viewOverlay) closeViewer();
    });

    // ============================
    // SAUDAÇÃO / INTENÇÃO
    // ============================

    greetingName.textContent = "Olá, KODUX";
    timeMini.textContent = formatTimeMini();

    if(featuredApp){
      heroSubtitle.textContent =
        "Streaming alinhado com o app destaque: " + featuredApp.title;
    }

    intentInput.addEventListener("change", () => {
      const txt = intentInput.value.trim();
      if(!txt) return;
      localStorage.setItem("dual_portal_intent_of_the_day", txt);
    });

    const savedIntent = localStorage.getItem("dual_portal_intent_of_the_day");
    if(savedIntent){
      intentInput.value = savedIntent;
    }

    // ============================
    // TOGGLE GRID / RAIL (APPS)
    // ============================

    function applyAppsView(mode){
      const finalMode = mode === "grid" ? "grid" : "rail";
      document.body.setAttribute("data-apps-view", finalMode);
      localStorage.setItem("dual_portal_apps_view", finalMode);
      if(finalMode === "grid"){
        appsViewToggleBtn.textContent = "↔ Rail";
      }else{
        appsViewToggleBtn.textContent = "▤ Grid";
      }
    }

    const savedAppsView = localStorage.getItem("dual_portal_apps_view") || "rail";
    applyAppsView(savedAppsView);

    appsViewToggleBtn.addEventListener("click", () => {
      const current = document.body.getAttribute("data-apps-view") || "rail";
      applyAppsView(current === "rail" ? "grid" : "rail");
    });

    // ============================
    // BOOT
    // ============================

    renderStreamingRails();
    renderPortalApps();
    renderCapsules();
    applyHeroFromItem(streamingItems[2] || streamingItems[0]);
  </script>

<!-- OVERRIDE v2 · Organizador de stack-card com data-stack-target -->
<script>
  (function () {
    const ATTR_TARGET = "data-stack-target";
    const ATTR_ORDER = "data-stack-order";

    function moveStacks(root) {
      const scope = root || document;
      const selector = "details.stack-card[" + ATTR_TARGET + "]";
      const cards = Array.from(scope.querySelectorAll(selector));

      cards.forEach(function (card) {
        const targetSelector = card.getAttribute(ATTR_TARGET) || ".apps-stacks";
        if (!targetSelector) return;

        const target = document.querySelector(targetSelector);
        if (!target) return;

        // já está dentro do target? não mexe
        if (card.closest(targetSelector) === target) return;

        const orderRaw = card.getAttribute(ATTR_ORDER);
        const order = orderRaw != null ? parseFloat(orderRaw) : null;

        if (order == null || Number.isNaN(order)) {
          target.appendChild(card);
          return;
        }

        // insere respeitando data-stack-order
        const siblings = Array.from(
          target.querySelectorAll("details.stack-card[" + ATTR_ORDER + "]")
        ).filter(function (el) {
          return el !== card;
        });

        let inserted = false;
        for (let i = 0; i < siblings.length; i++) {
          const sOrderRaw = siblings[i].getAttribute(ATTR_ORDER);
          const sOrder = sOrderRaw != null ? parseFloat(sOrderRaw) : null;
          if (sOrder != null && !Number.isNaN(sOrder) && sOrder > order) {
            target.insertBefore(card, siblings[i]);
            inserted = true;
            break;
          }
        }

        if (!inserted) {
          target.appendChild(card);
        }
      });
    }

    function initMove() {
      moveStacks(document);
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initMove);
    } else {
      initMove();
    }

    // Observa novos patches (ex: injetor HTML jogando cards depois)
    const observer = new MutationObserver(function (mutations) {
      for (const m of mutations) {
        m.addedNodes.forEach(function (node) {
          if (!(node instanceof Element)) return;

          if (
            node.matches &&
            node.matches("details.stack-card[" + ATTR_TARGET + "]")
          ) {
            moveStacks(node);
          } else if (node.querySelector) {
            const inner = node.querySelector("details.stack-card[" + ATTR_TARGET + "]");
            if (inner) moveStacks(node);
          }
        });
      }
    });

    observer.observe(document.documentElement, {
      childList: true,
      subtree: true
    });

    console.log("[OVERRIDE v2] Ativo · aguardando stack-card com data-stack-target");
  })();
</script>

<!-- STACK · Motor de Stacks v3 · Nested + Add App (inner card) + TTS global -->
<details
  class="stack-card"
  id="stack-manager-override"
  data-stack-target=".apps-stacks"
  data-stack-order="0"
>
  <summary>
    <div class="stack-summary-main">
      <div class="stack-title">Motor de Stacks v3 · Nested</div>
      <div class="stack-sub">
        Ler todos os cards, ligar/desligar, agrupar, criar apps/patches e ativar TTS global.
      </div>
    </div>
    <span class="stack-pill">Manager · Global</span>
  </summary>

  <div class="stack-body">
    <!-- VISÃO GERAL -->
    <div class="stack-field-label">Visão geral</div>
    <p class="flow-text" style="font-size:11px;color:var(--text-soft);line-height:1.6;margin-bottom:0.4rem;">
      Este motor enxerga todos os <code>details.stack-card</code> do seu index
      (vídeos, apps, root...) e permite:
      <br>· Ligar/desligar cada card (ON/OFF)
      <br>· Ligar/desligar grupos inteiros (nested)
      <br>· Criar novos cards de patch ou App
      <br>· Adicionar TTS em todos os stacks, com botão dedicado por card
    </p>

    <!-- GRUPOS NESTED -->
    <div class="stack-field-label">Grupos de cards (nested)</div>
    <div id="stackMgrGroupsNested" style="display:flex;flex-direction:column;gap:6px;margin-bottom:0.6rem;">
      <!-- grupos + cards gerados via JS -->
    </div>

    <button class="pill-btn" type="button" id="stackMgrReloadBtn" style="font-size:11px;margin-bottom:0.7rem;">
      🔄 Recarregar lista de cards
    </button>

    <hr style="border:none;border-top:1px solid var(--border-soft,rgba(148,163,184,0.5));margin:0.7rem 0;">

    <!-- INNER CARD · CRIAÇÃO DE NOVOS CARDS -->
    <details class="mgr-inner-card" open>
      <summary>
        <div class="mgr-inner-header">
          <div class="mgr-inner-main">
            <div class="mgr-inner-title">Criar novo card</div>
            <div class="mgr-inner-sub">Patch genérico ou App nested com URL, tag e TTS.</div>
          </div>
          <span class="mgr-inner-pill">Novo · Stack</span>
        </div>
      </summary>

      <div class="mgr-inner-body">
        <!-- Tipo de card -->
        <div id="stackMgrTypeRow" style="display:flex;gap:4px;flex-wrap:wrap;margin:0.2rem 0 0.45rem;">
          <button type="button" class="mgr-type-pill is-active" data-type="patch">
            🧩 Patch genérico
          </button>
          <button type="button" class="mgr-type-pill" data-type="app">
            📱 App (nested)
          </button>
        </div>

        <div class="stack-input-row" style="display:flex;flex-direction:column;gap:4px;margin-bottom:0.35rem;">
          <label style="font-size:11px;color:var(--text-soft);">
            Título do card
            <input
              id="stackMgrNewTitle"
              class="stack-input"
              type="text"
              placeholder="Ex: Emoção v3 · Modo experimental"
            >
          </label>

          <label style="font-size:11px;color:var(--text-soft);">
            Grupo (<code>data-stack-group</code>)
            <input
              id="stackMgrNewGroup"
              class="stack-input"
              type="text"
              placeholder="Ex: apps, videos, grego, ritual (default: apps p/ tipo App)"
            >
          </label>

          <label style="font-size:11px;color:var(--text-soft);">
            Target (<code>data-stack-target</code>)
            <input
              id="stackMgrNewTarget"
              class="stack-input"
              type="text"
              placeholder=".apps-stacks"
              value=".apps-stacks"
            >
          </label>

          <label style="font-size:11px;color:var(--text-soft);">
            Ordem opcional (<code>data-stack-order</code>)
            <input
              id="stackMgrNewOrder"
              class="stack-input"
              type="number"
              min="0"
              step="1"
              placeholder="Ex: 10"
            >
          </label>
        </div>

        <!-- Campos extras para tipo App -->
        <div id="stackMgrAppFields" style="display:none;flex-direction:column;gap:4px;margin-bottom:0.35rem;">
          <div class="stack-field-label" style="margin-bottom:0;">Campos para tipo App</div>

          <label style="font-size:11px;color:var(--text-soft);">
            URL do app
            <input
              id="stackMgrNewAppUrl"
              class="stack-input"
              type="text"
              placeholder="Ex: https://meu-app.vercel.app"
            >
          </label>

          <label style="font-size:11px;color:var(--text-soft);">
            Tag / categoria do app
            <input
              id="stackMgrNewAppTag"
              class="stack-input"
              type="text"
              placeholder="Ex: Player, Editor, Ritual"
            >
          </label>

          <label style="font-size:11px;color:var(--text-soft);">
            Descrição curta (usada também no TTS)
            <input
              id="stackMgrNewAppDesc"
              class="stack-input"
              type="text"
              placeholder="Ex: Player de trilhas do KOBLLUX"
            >
          </label>
        </div>

        <label class="stack-field-label" for="stackMgrNewHtml">
          HTML interno do card (modo Patch genérico)
        </label>
        <textarea
          id="stackMgrNewHtml"
          class="stack-input"
          rows="5"
          placeholder="Modo Patch: cole aqui o conteúdo interno do card (sem &lt;details&gt;).&#10;Modo App: este campo é opcional."
          style="font-family:monospace;font-size:11px;"
        ></textarea>

        <div style="display:flex;gap:6px;margin-top:0.4rem;flex-wrap:wrap;">
          <button class="pill-btn" type="button" id="stackMgrAddBtn" style="font-size:11px;">
            ➕ Criar card
          </button>
          <button class="pill-btn" type="button" id="stackMgrClearFormBtn" style="font-size:11px;">
            🧹 Limpar formulário
          </button>
        </div>

        <div class="stack-footnote" style="margin-top:0.4rem;">
          • Tipo <strong>Patch</strong> cria um stack genérico com o HTML que você colar.<br>
          • Tipo <strong>App</strong> cria um card com botão de abrir e descrição, entrando no grupo definido (ou em <code>apps</code> por padrão).
        </div>
      </div>
    </details>
  </div>
</details>

<style>
  /* Motor de Stacks v3 · estilos locais (nested + inner card + TTS global) */

  /* INNER CARD (nested dentro do Manager) */
  #stack-manager-override .mgr-inner-card {
    border-radius: 10px;
    border: 1px solid var(--border-soft, rgba(148,163,184,0.7));
    background: radial-gradient(circle at top, rgba(15,23,42,0.96), rgba(15,23,42,0.88));
    margin-top: 0.4rem;
    overflow: hidden;
  }
  #stack-manager-override .mgr-inner-card summary {
    list-style: none;
    cursor: pointer;
  }
  #stack-manager-override .mgr-inner-card summary::-webkit-details-marker {
    display: none;
  }
  #stack-manager-override .mgr-inner-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 4px 8px;
  }
  #stack-manager-override .mgr-inner-main {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }
  #stack-manager-override .mgr-inner-title {
    font-size: 11px;
    color: var(--text-strong,#e5f0ff);
  }
  #stack-manager-override .mgr-inner-sub {
    font-size: 10px;
    color: var(--text-soft,#9ca3af);
  }
  #stack-manager-override .mgr-inner-pill {
    font-size: 10px;
    padding-inline: 0.6rem;
    padding-block: 0.2rem;
    border-radius: 999px;
    border: 1px solid var(--border-soft,rgba(148,163,184,0.8));
    background: rgba(15,23,42,0.92);
    white-space: nowrap;
  }
  #stack-manager-override .mgr-inner-body {
    padding: 4px 8px 8px;
    border-top: 1px solid rgba(15,23,42,0.96);
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  #stack-manager-override .mgr-type-pill {
    font-size: 10px;
    padding-inline: 0.6rem;
    padding-block: 0.2rem;
    border-radius: 999px;
    border: 1px solid var(--border-soft, rgba(148,163,184,0.6));
    background: rgba(15,23,42,0.92);
    cursor: pointer;
    white-space: nowrap;
    transition: background .18s ease, border-color .18s ease, transform .08s ease;
  }
  #stack-manager-override .mgr-type-pill.is-active {
    border-color: var(--accent, #38bdf8);
    background: radial-gradient(circle at 0% 0%, rgba(56,189,248,0.32), transparent 68%);
    transform: translateY(-1px);
  }

  /* GRUPOS NESTED */
  #stack-manager-override .mgr-group {
    border-radius: 10px;
    border: 1px solid var(--border-soft, rgba(148,163,184,0.6));
    background: rgba(15,23,42,0.9);
    overflow: hidden;
  }

  #stack-manager-override .mgr-group summary {
    list-style: none;
    cursor: pointer;
  }
  #stack-manager-override .mgr-group summary::-webkit-details-marker {
    display: none;
  }

  #stack-manager-override .mgr-group-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 4px 8px;
  }

  #stack-manager-override .mgr-group-main {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  #stack-manager-override .mgr-group-title {
    font-size: 11px;
    color: var(--text-strong, #e5f0ff);
  }

  #stack-manager-override .mgr-group-meta {
    font-size: 10px;
    color: var(--text-soft, #9ca3af);
  }

  #stack-manager-override .mgr-group-btn {
    font-size: 10px;
    padding-inline: 0.5rem;
    padding-block: 0.15rem;
    border-radius: 999px;
    border-width: 1px;
    border-style: solid;
    border-color: var(--border-soft, rgba(148,163,184,0.6));
    background: rgba(15,23,42,0.9);
    white-space: nowrap;
    cursor: pointer;
  }

  #stack-manager-override .mgr-group-btn.is-off {
    border-color: #f97316;
    background: radial-gradient(circle at 0% 0%, rgba(248,113,113,0.24), transparent 70%);
    color: #fed7aa;
  }

  #stack-manager-override .mgr-group-body {
    padding: 4px 8px 6px;
    border-top: 1px solid rgba(15,23,42,0.9);
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  #stack-manager-override .mgr-row {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    border-radius: 7px;
    border: 1px solid var(--border-soft, rgba(148,163,184,0.5));
    background: rgba(15,23,42,0.98);
  }

  #stack-manager-override .mgr-row-main {
    flex: 1;
    min-width: 0;
  }

  #stack-manager-override .mgr-row-title {
    font-size: 11px;
    color: var(--text-strong, #e5f0ff);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #stack-manager-override .mgr-row-meta {
    font-size: 10px;
    color: var(--text-soft, #9ca3af);
  }

  #stack-manager-override .mgr-row-actions {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  #stack-manager-override .mgr-btn {
    font-size: 10px;
    padding-inline: 0.5rem;
    padding-block: 0.15rem;
    border-radius: 999px;
    border-width: 1px;
    border-style: solid;
    border-color: var(--border-soft, rgba(148,163,184,0.6));
    background: rgba(15,23,42,0.9);
    white-space: nowrap;
    cursor: pointer;
  }

  #stack-manager-override .mgr-btn-toggle-on {
    border-color: #22c55e;
    background: radial-gradient(circle at 0% 0%, rgba(34,197,94,0.24), transparent 70%);
    color: #bbf7d0;
  }

  #stack-manager-override .mgr-btn-toggle-off {
    border-color: #f97316;
    background: radial-gradient(circle at 0% 0%, rgba(248,113,113,0.24), transparent 70%);
    color: #fed7aa;
  }

  #stack-manager-override .mgr-btn-tts {
    border-color: #38bdf8;
    background: radial-gradient(circle at 0% 0%, rgba(56,189,248,0.28), transparent 70%);
    color: #e0f2fe;
    border-radius: 999px;
    min-width: 26px;
    min-height: 26px;
    padding-inline: 0.3rem;
  }

  #stack-manager-override .mgr-btn-tts span {
    font-size: 13px;
  }

  /* Botão TTS global que aparece em TODO stack-card (fora do manager) */
  .stack-tts-btn {
    margin-left: 4px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.7);
    background: radial-gradient(circle at 0% 0%, rgba(56,189,248,0.3), transparent 70%);
    padding: 0 6px;
    height: 20px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .stack-tts-btn span {
    font-size: 11px;
  }
</style>

<script>
  // Motor de Stacks v3 · Nested + Add App + TTS global
  (function () {
    const root = document.getElementById("stack-manager-override");
    if (!root) return;

    const VIS_KEY = "dual_stack_visibility_v3";
    const GROUP_KEY = "dual_stack_groups_v3";

    const groupsContainer = root.querySelector("#stackMgrGroupsNested");
    const reloadBtn = root.querySelector("#stackMgrReloadBtn");

    const titleInput = root.querySelector("#stackMgrNewTitle");
    const groupInput = root.querySelector("#stackMgrNewGroup");
    const targetInput = root.querySelector("#stackMgrNewTarget");
    const orderInput = root.querySelector("#stackMgrNewOrder");
    const htmlInput = root.querySelector("#stackMgrNewHtml");

    const appFieldsBox = root.querySelector("#stackMgrAppFields");
    const appUrlInput = root.querySelector("#stackMgrNewAppUrl");
    const appTagInput = root.querySelector("#stackMgrNewAppTag");
    const appDescInput = root.querySelector("#stackMgrNewAppDesc");

    const typeRow = root.querySelector("#stackMgrTypeRow");
    const typePills = typeRow ? Array.from(typeRow.querySelectorAll(".mgr-type-pill")) : [];
    let currentType = "patch";

    const addBtn = root.querySelector("#stackMgrAddBtn");
    const clearBtn = root.querySelector("#stackMgrClearFormBtn");

    const CARD_SELECTOR = "details.stack-card";
    const SELF_ID = "stack-manager-override";

    // ==== TTS helper ====
    function speakText(text) {
      try {
        // Modo IA externo (OpenRouter etc.)
        if (window.stackTtsMode === "ai" && typeof window.playStackTtsAI === "function") {
          window.playStackTtsAI(text);
          return;
        }
        // Modo TTS custom do app
        if (typeof window.playStackTts === "function") {
          window.playStackTts(text);
          return;
        }
      } catch (e) {}

      // Fallback: Web Speech API
      if (!("speechSynthesis" in window)) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = "pt-BR";
      utter.rate = 1;
      utter.pitch = 1;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    }

    // Adiciona botão TTS em TODO stack-card (uma vez só)
    function ensureStackTtsButton(card, groupName) {
      if (!card || card.id === SELF_ID) return;
      const summary = card.querySelector("summary");
      if (!summary) return;

      // já existe botão?
      if (summary.querySelector(".stack-tts-btn")) return;

      const anchor =
        summary.querySelector(".stack-summary-main") ||
        summary;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "stack-tts-btn";
      btn.title = "Ouvir este card";
      btn.innerHTML = "<span>◎</span>";

      btn.addEventListener("click", function (ev) {
        ev.stopPropagation();
        const title = getTitle(card);
        let bodyText = "";
        const body = card.querySelector(".stack-body");
        if (body) {
          bodyText = body.innerText || body.textContent || "";
        }
        const phrase = "Grupo " + groupName + ". Card: " + title + ". " + bodyText;
        speakText(phrase);
      });

      anchor.appendChild(btn);
    }

    // Tipo de card (Patch/App)
    if (typeRow) {
      typePills.forEach((btn) => {
        btn.addEventListener("click", () => {
          const t = btn.dataset.type || "patch";
          currentType = t;

          typePills.forEach((b) => b.classList.toggle("is-active", b === btn));

          if (t === "app") {
            appFieldsBox.style.display = "flex";
          } else {
            appFieldsBox.style.display = "none";
          }
        });
      });
    }

    function loadMap(key) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : {};
      } catch (e) {
        return {};
      }
    }

    function saveMap(key, map) {
      try {
        localStorage.setItem(key, JSON.stringify(map));
      } catch (e) {}
    }

    function getAllCards() {
      const all = Array.from(document.querySelectorAll(CARD_SELECTOR));
      return all.filter(function (el) {
        return el.id !== SELF_ID;
      });
    }

    function ensureCardId(card, idx) {
      let id = card.getAttribute("id") || card.getAttribute("data-stack-id");
      if (!id) {
        id = "stack-" + (idx + 1) + "-" + Date.now();
        card.setAttribute("data-stack-id", id);
      }
      return id;
    }

    function detectGroup(card) {
      const explicit = card.getAttribute("data-stack-group");
      if (explicit) return explicit;

      if (card.closest(".video-accordion")) return "videos";
      if (card.closest(".apps-stacks")) return "apps";

      return "root";
    }

    function getTitle(card) {
      const t = card.querySelector(".stack-title");
      if (t && t.textContent.trim()) return t.textContent.trim();
      return card.getAttribute("id") || card.getAttribute("data-stack-id") || "Stack sem título";
    }

    function applyVisibility(card, visible, visMap, id) {
      const key = id || ensureCardId(card, 0);
      visMap[key] = !!visible;
      card.hidden = !visible;
    }

    function render() {
      const cards = getAllCards();
      const visMap = loadMap(VIS_KEY);
      const groupState = loadMap(GROUP_KEY);

      // Estado inicial respeita tela ou storage
      cards.forEach(function (card, idx) {
        const id = ensureCardId(card, idx);
        const currentVisible = !card.hidden;
        const stored = visMap.hasOwnProperty(id) ? !!visMap[id] : currentVisible;
        card.hidden = !stored;
        visMap[id] = stored;
      });
      saveMap(VIS_KEY, visMap);

      // Agrupar por grupo detectado
      const groups = {};
      cards.forEach(function (card, idx) {
        const g = detectGroup(card);
        if (!groups[g]) groups[g] = [];
        groups[g].push(card);
      });

      // Render nested
      groupsContainer.innerHTML = "";
      Object.keys(groups)
        .sort()
        .forEach(function (g) {
          const groupCards = groups[g];
          const active = groupState[g] !== false; // default: true

          const details = document.createElement("details");
          details.className = "mgr-group";
          details.open = true;

          const summary = document.createElement("summary");
          const header = document.createElement("div");
          header.className = "mgr-group-header";

          const main = document.createElement("div");
          main.className = "mgr-group-main";

          const titleEl = document.createElement("div");
          titleEl.className = "mgr-group-title";
          titleEl.textContent = g;

          const metaEl = document.createElement("div");
          metaEl.className = "mgr-group-meta";
          metaEl.textContent = groupCards.length + " card(s)";

          main.appendChild(titleEl);
          main.appendChild(metaEl);

          const btnGroup = document.createElement("button");
          btnGroup.type = "button";
          btnGroup.className = "mgr-group-btn" + (active ? "" : " is-off");
          btnGroup.textContent = active ? "Grupo ON" : "Grupo OFF";

          btnGroup.addEventListener("click", function (ev) {
            ev.preventDefault();
            ev.stopPropagation();

            const nowActive = groupState[g] !== false;
            const next = !nowActive;
            groupState[g] = next;
            saveMap(GROUP_KEY, groupState);

            btnGroup.classList.toggle("is-off", !next);
            btnGroup.textContent = next ? "Grupo ON" : "Grupo OFF";

            const visMapLocal = loadMap(VIS_KEY);
            groupCards.forEach(function (card, idx) {
              const id = ensureCardId(card, idx);
              if (!next) {
                applyVisibility(card, false, visMapLocal, id);
              } else {
                const stored = visMapLocal.hasOwnProperty(id) ? !!visMapLocal[id] : true;
                applyVisibility(card, stored, visMapLocal, id);
              }
            });
            saveMap(VIS_KEY, visMapLocal);
          });

          header.appendChild(main);
          header.appendChild(btnGroup);
          summary.appendChild(header);

          const body = document.createElement("div");
          body.className = "mgr-group-body";

          groupCards.forEach(function (card, idx) {
            const id = ensureCardId(card, idx);
            const visible = !card.hidden;
            const title = getTitle(card);
            const order = card.getAttribute("data-stack-order") || "—";

            // garante botão TTS no próprio stack
            ensureStackTtsButton(card, g);

            const row = document.createElement("div");
            row.className = "mgr-row";
            row.dataset.stackId = id;

            const rMain = document.createElement("div");
            rMain.className = "mgr-row-main";

            const rTitle = document.createElement("div");
            rTitle.className = "mgr-row-title";
            rTitle.textContent = title;

            const rMeta = document.createElement("div");
            rMeta.className = "mgr-row-meta";
            rMeta.textContent = "id: " + id + " · ordem: " + order;

            rMain.appendChild(rTitle);
            rMain.appendChild(rMeta);

            const actions = document.createElement("div");
            actions.className = "mgr-row-actions";

            // Botão TTS (resumo curto do card)
            const btnTts = document.createElement("button");
            btnTts.type = "button";
            btnTts.className = "mgr-btn mgr-btn-tts";
            btnTts.innerHTML = "<span>◎</span>";
            btnTts.title = "Ouvir resumo do card";

            btnTts.addEventListener("click", function (ev) {
              ev.stopPropagation();
              const bodyEl = card.querySelector(".stack-body");
              const shortText = bodyEl
                ? (bodyEl.innerText || bodyEl.textContent || "").slice(0, 240)
                : "";
              const phrase = "Grupo " + g + ". Card: " + title + ". " + shortText;
              speakText(phrase);
            });

            // Botão ON/OFF
            const btnToggle = document.createElement("button");
            btnToggle.type = "button";
            btnToggle.className =
              "mgr-btn " + (visible ? "mgr-btn-toggle-on" : "mgr-btn-toggle-off");
            btnToggle.textContent = visible ? "ON" : "OFF";

            btnToggle.addEventListener("click", function () {
              const visMapLocal = loadMap(VIS_KEY);
              const nowVisible = !card.hidden;
              const next = !nowVisible;
              applyVisibility(card, next, visMapLocal, id);
              saveMap(VIS_KEY, visMapLocal);

              btnToggle.textContent = next ? "ON" : "OFF";
              btnToggle.classList.toggle("mgr-btn-toggle-on", next);
              btnToggle.classList.toggle("mgr-btn-toggle-off", !next);
            });

            actions.appendChild(btnTts);
            actions.appendChild(btnToggle);

            row.appendChild(rMain);
            row.appendChild(actions);
            body.appendChild(row);
          });

          details.appendChild(summary);
          details.appendChild(body);
          groupsContainer.appendChild(details);
        });
    }

    if (reloadBtn) {
      reloadBtn.addEventListener("click", render);
    }

    if (addBtn) {
      addBtn.addEventListener("click", function () {
        const title = (titleInput && titleInput.value.trim()) || "Card";
        let group = groupInput && groupInput.value.trim();
        const target = (targetInput && targetInput.value.trim()) || ".apps-stacks";
        const order = orderInput && orderInput.value.trim();
        const innerHtml = (htmlInput && htmlInput.value.trim()) || "";

        let type = currentType || "patch";

        if (type === "app" && !group) {
          group = "apps";
        }

        const details = document.createElement("details");
        details.className = "stack-card";
        details.setAttribute("data-stack-target", target);
        if (group) details.setAttribute("data-stack-group", group);
        if (order) details.setAttribute("data-stack-order", order);

        const summary = document.createElement("summary");
        summary.innerHTML =
          '<div class="stack-summary-main">' +
          '<div class="stack-title">' + title.replace(/</g, "&lt;") + '</div>' +
          '<div class="stack-sub">Card criado via Motor de Stacks v3 · ' +
          (type === "app" ? "App" : "Patch") +
          '.</div>' +
          "</div>" +
          '<span class="stack-pill">' + (type === "app" ? "App" : "Patch") + "</span>";

        const body = document.createElement("div");
        body.className = "stack-body";

        if (type === "app") {
          const url = appUrlInput && appUrlInput.value.trim();
          const tag = appTagInput && appTagInput.value.trim();
          const desc = appDescInput && appDescInput.value.trim();

          body.innerHTML =
            '<div class="stack-field-label">App</div>' +
            '<p style="font-size:11px;color:var(--text-soft);line-height:1.6;margin-bottom:0.45rem;">' +
            (desc ? desc.replace(/</g, "&lt;") : "App criado via Manager.") +
            "</p>" +
            '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:0.4rem;">' +
            (tag
              ? '<span class="stack-pill" style="font-size:10px;">' +
                tag.replace(/</g, "&lt;") +
                "</span>"
              : "") +
            (url
              ? '<button type="button" class="pill-btn app-open-btn" data-app-url="' +
                url.replace(/"/g, "&quot;") +
                '" style="font-size:11px;">Abrir app</button>'
              : "") +
            "</div>" +
            (url
              ? '<div class="stack-footnote" style="font-size:10px;word-break:break-all;">' +
                url.replace(/</g, "&lt;") +
                "</div>"
              : "");
        } else {
          if (innerHtml) {
            body.innerHTML = innerHtml;
          } else {
            body.innerHTML =
              '<div class="stack-field-label">Novo card vazio</div>' +
              '<p style="font-size:11px;color:var(--text-soft);">Edite este conteúdo depois.</p>';
          }
        }

        details.appendChild(summary);
        details.appendChild(body);

        document.body.appendChild(details);

        // apps: botão "Abrir app"
        setTimeout(() => {
          const btns = details.querySelectorAll(".app-open-btn");
          btns.forEach((b) => {
            b.addEventListener("click", () => {
              const url = b.getAttribute("data-app-url");
              if (!url) return;

              const frame = document.getElementById("localViewerFrame");
              if (frame && frame.tagName === "IFRAME") {
                frame.src = url;
              } else {
                window.open(url, "_blank");
              }
            });
          });
        }, 0);

        setTimeout(render, 200);
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", function () {
        if (titleInput) titleInput.value = "";
        if (groupInput) groupInput.value = "";
        if (orderInput) orderInput.value = "";
        if (htmlInput) htmlInput.value = "";
        if (appUrlInput) appUrlInput.value = "";
        if (appTagInput) appTagInput.value = "";
        if (appDescInput) appDescInput.value = "";
      });
    }

    function init() {
      render();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>

<!-- ============ OVERRIDE V9 — TTS ORB NOS STACKS ============ -->
<script>
(() => {
  // Só roda quando o DOM estiver pronto
  const run = () => {
    const stacks = document.querySelectorAll('details.stack-card');
    if (!stacks.length) return;

    // Função de fala reutilizável
    function speak(text) {
      if (!text || !('speechSynthesis' in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'pt-BR';
      u.rate = 1.0;
      u.pitch = 1.02;
      try { window.speechSynthesis.cancel(); } catch (e) {}
      window.speechSynthesis.speak(u);
    }

    // Monta o texto de um stack inteiro
    function getStackText(stackEl) {
      const parts = [];

      const title = stackEl.querySelector('.stack-title');
      if (title && title.textContent.trim()) {
        parts.push(title.textContent.trim());
      }

      const sub = stackEl.querySelector('.stack-sub');
      if (sub && sub.textContent.trim()) {
        parts.push(sub.textContent.trim());
      }

      // labels + possíveis valores
      stackEl.querySelectorAll('.stack-field-label').forEach(lbl => {
        const labelText = lbl.textContent.trim();
        let valueText = '';

        // tenta achar um input/textarea logo depois
        const next = lbl.nextElementSibling;
        if (next && next.classList.contains('stack-input')) {
          if ('value' in next && next.value) {
            valueText = next.value.trim();
          } else if (next.textContent) {
            valueText = next.textContent.trim();
          }
        }

        if (labelText || valueText) {
          parts.push(labelText + (valueText ? ': ' + valueText : ''));
        }
      });

      // notas/footnotes e parágrafos
      stackEl.querySelectorAll('.stack-footnote, .stack-body p').forEach(el => {
        const t = el.textContent.trim();
        if (t) parts.push(t);
      });

      return parts.join('. ');
    }

    stacks.forEach(stackEl => {
      const summary = stackEl.querySelector('summary');
      if (!summary) return;

      // Se já tiver orb de TTS, não duplica
      if (summary.querySelector('.tts-btn, .stack-tts')) return;

      // Cria orb usando a mesma estética de TTS já existente
      const orb = document.createElement('button');
      orb.type = 'button';
      orb.className = 'tts-btn stack-tts';
      orb.setAttribute('aria-label', 'Ouvir este stack');
      orb.textContent = '◎';

      orb.addEventListener('click', (ev) => {
        ev.stopPropagation(); // não abrir/fechar o details ao clicar no orb
        const text = getStackText(stackEl);
        speak(text);
      });

      // Joga o orb no final do summary (lado direito, junto da pill)
      summary.appendChild(orb);
    });
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', run, { once: true });
  } else {
    run();
  }
})();
</script>
<!-- ============ /OVERRIDE V9 — TTS ORB NOS STACKS ============ -->


<!-- OVERRIDE v9 · Viewers (mini + principal) -->

<!-- OVERRIDE v10 · Viewers (mini + principal) -->
<style>
  /* ============================
     MINI VIEWER · ALTURA 220/620
     ============================ */
  .stack-viewer-card{
    position: relative;
  }

  .stack-viewer-toggle-size{
    border-radius: 999px;
    padding: 6px 10px;
    font-size: 11px;
    border: 0;
    cursor: pointer;
    background: radial-gradient(circle at 0 0, #3bffb3 0%, #00d4ff 40%, #141429 100%);
    color: #02030a;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.05);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }

  .stack-viewer-toggle-size span{
    font-size: 12px;
  }

  /* Estado padrão: compacto (220px) */
  .stack-viewer-card[data-size="min"] .stack-viewer-frame{
    height: 220px;
  }

  /* Estado expandido: 620px */
  .stack-viewer-card[data-size="max"] .stack-viewer-frame{
    height: 620px;
  }

  @media (max-width: 640px){
    .stack-viewer-card[data-size="max"] .stack-viewer-frame{
      height: 520px;
    }
  }

  /* ============================
     VIEWER PRINCIPAL · COMPACT/FULL
     ============================ */

  /* Mantém o fade de opacidade e adiciona background */
  .view-overlay{
    transition: opacity 0.24s ease, background 0.25s ease;
  }

  .view-panel{
    transition: max-height 0.25s ease, transform 0.25s ease;
  }

  /* Agora o body ocupa a altura do panel */
  .view-body{
    flex: 1 1 auto;
    min-height: 0;
  }

  /* Zera a min-height fixa anterior do iframe
     (este seletor ganha do #viewVideoHolder iframe isolado) */
  .view-overlay #viewVideoHolder iframe{
    min-height: 0;
    height: auto;
  }

  /* COMPACT = “antigo maximizado” (viewer grande padrão) */
  .view-overlay[data-size="compact"] .view-panel{
    max-height: 60vh;
  }

  .view-overlay[data-size="compact"] #viewVideoHolder iframe{
    height: 296px;
    min-height: 296px;
  }

  /* FULL = modo app 9:16, quase tela cheia */
  .view-overlay[data-size="full"] .view-panel{
    max-height: 100vh;
    height: 100vh;
  }

  .view-overlay[data-size="full"] .view-body{
    padding-bottom: 4px;
  }

  .view-overlay[data-size="full"] #viewVideoHolder iframe{
    height: 78vh;
    min-height: 78vh;
  }

  /* Mobile: garante que continua gigante no iPhone */
  @media (max-width: 640px){
    .view-overlay[data-size="compact"] #viewVideoHolder iframe{
      height: 39vh;
      min-height: 39vh;
    }
    .view-overlay[data-size="full"] #viewVideoHolder iframe{
      height: 78vh;
      min-height: 78vh;
    }
  }

  /* Botão de tamanho do viewer (mesmo estilo que você já tinha) */
  .view-size-toggle-btn{
    border-radius: 999px;
    border: 0;
    padding: 6px 10px;
    font-size: 8px;
    cursor: pointer;
    background: radial-gradient(circle at 100% 0, #ffcf8a 0%, #ff7ad9 35%, #141429 100%);
    color: #02030a;
    box-shadow: 0 0 0 1px rgba(255,255,255,0.08);
    display: inline-flex;
    align-items: center;
    gap: 4px;
    white-space: nowrap;
  }

  .view-size-toggle-btn span{
    font-size: 8px;
  }

  .view-header-actions{
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
</style>

<script>
  (function(){
    /* =========================================
       MINI VIEWER (localViewerFrame) · TOGGLE
       ========================================= */
    const MINI_KEY = "dual_stackViewerSize_v1";

    function setupMiniViewerToggle(){
      const card = document.querySelector(".stack-viewer-card");
      if(!card) return;

      const resetBtn = card.querySelector(".stack-viewer-reset");
      const header  = card.querySelector(".stack-viewer-header");
      if(!header || !resetBtn) return;

      const currentSize = localStorage.getItem(MINI_KEY) === "max" ? "max" : "min";
      card.dataset.size = currentSize;

      // Cria o botão de toggle
      const toggleBtn = document.createElement("button");
      toggleBtn.type = "button";
      toggleBtn.className = "stack-viewer-toggle-size";
      const iconSpan = document.createElement("span");
      iconSpan.textContent = "⬍";
      const labelSpan = document.createElement("span");
      toggleBtn.appendChild(iconSpan);
      toggleBtn.appendChild(labelSpan);

      function applyLabel(size){
        if(size === "max"){
          labelSpan.textContent = "Minimizar preview";
        }else{
          labelSpan.textContent = "Expandir preview";
        }
      }
      applyLabel(currentSize);

      toggleBtn.addEventListener("click", function(){
        const next = card.dataset.size === "max" ? "min" : "max";
        card.dataset.size = next;
        localStorage.setItem(MINI_KEY, next);
        applyLabel(next);
      });

      // Insere o botão antes do reset pra ficar lado a lado
      resetBtn.parentNode.insertBefore(toggleBtn, resetBtn);
    }

    /* =========================================
       VIEWER PRINCIPAL (viewOverlay) · TOGGLE
       ========================================= */
    const VIEW_KEY = "dual_viewOverlaySize_v1";

    function setupMainViewerToggle(){
      const viewOverlay = document.getElementById("viewOverlay");
      if(!viewOverlay) return;

      const header = viewOverlay.querySelector(".view-header");
      const backBtn = document.getElementById("viewBackBtn");
      if(!header) return;

      // Wrapper opcional pra alinhar botões à direita
      let actionsWrap = header.querySelector(".view-header-actions");
      if(!actionsWrap){
        actionsWrap = document.createElement("div");
        actionsWrap.className = "view-header-actions";
        // joga o botão back existente pra dentro do wrapper
        if(backBtn && backBtn.parentNode === header){
          header.removeChild(backBtn);
          actionsWrap.appendChild(backBtn);
        }
        header.appendChild(actionsWrap);
      }

      const sizeBtn = document.createElement("button");
      sizeBtn.type = "button";
      sizeBtn.className = "view-size-toggle-btn";
      const iconSpan = document.createElement("span");
      iconSpan.textContent = "▢";
      const labelSpan = document.createElement("span");
      sizeBtn.appendChild(iconSpan);
      sizeBtn.appendChild(labelSpan);
      actionsWrap.appendChild(sizeBtn);

      function applyViewSize(mode){
        const safe = mode === "full" ? "full" : "compact";
        viewOverlay.dataset.size = safe;
        localStorage.setItem(VIEW_KEY, safe);
        if(safe === "full"){
          labelSpan.textContent = "Modo compacto";
        }else{
          labelSpan.textContent = "Maximizar viewer";
        }
      }

      const initialMode = localStorage.getItem(VIEW_KEY) || "compact";
      applyViewSize(initialMode);

      sizeBtn.addEventListener("click", function(){
        const next = viewOverlay.dataset.size === "full" ? "compact" : "full";
        applyViewSize(next);
      });

      // Hook leve no openInViewer pra respeitar o último modo escolhido
      if(typeof window.openInViewer === "function"){
        const originalOpen = window.openInViewer;
        window.openInViewer = function(opts){
          originalOpen(opts || {});
          const saved = localStorage.getItem(VIEW_KEY) || "compact";
          applyViewSize(saved);
        };
      }
    }

    // Run depois que tudo existe no DOM
    if(document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", function(){
        setupMiniViewerToggle();
        setupMainViewerToggle();
      });
    }else{
      setupMiniViewerToggle();
      setupMainViewerToggle();
    }
  })();
</script>

<!-- STACK · Patch CSS Nebula Pro -->
<details
  class="stack-card"
  id="card-css-nebula-patch"
  data-stack-target=".apps-stacks"
  data-stack-group="system"
  data-stack-order="99"
>
  <summary>
    <div class="stack-summary-main">
      <div class="stack-title">Patch CSS · Nebula Pro</div>
      <div class="stack-sub">
        Liga/desliga o pacote de estilos Nebula (Markdown, Stacks, Orb, FAB).
      </div>
    </div>
    <span class="stack-pill">Tema · Patch</span>
  </summary>

  <div class="stack-body">
    <div class="stack-field-label">Estado do patch</div>
    <div
      data-role="nebula-status"
      style="font-size:.9rem;color:var(--muted);margin-bottom:6px;"
    >
      Checando…
    </div>

    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;">
      <button
        type="button"
        class="pill-btn"
        data-role="nebula-apply"
      >
        ⚡ Aplicar Patch Nebula Pro
      </button>
      <button
        type="button"
        class="pill-btn ghost"
        data-role="nebula-remove"
      >
        🧹 Remover Patch
      </button>
    </div>

    <div class="stack-field-label" style="margin-top:12px;">O que esse patch faz?</div>
    <ul style="font-size:.85rem;color:var(--muted);padding-left:1.1rem;margin:6px 0;">
      <li>Ativa visual de <b>Livro Vivo / Markdown+</b> (callouts, tabelas, code blocks).</li>
      <li>Trava as stacks em layout <b>100% vertical (1 coluna)</b>.</li>
      <li>Liga o <b>Orb 2D</b> com animação e brilho Nebula.</li>
      <li>Refina o menu do <b>FAB</b> (botões flutuantes bonitos).</li>
    </ul>

    <p class="stack-footnote" style="margin-top:4px;">
      Safe-mode: o patch só cria/atualiza 3 &lt;style&gt; com IDs fixos.
      Se você já tiver versões antigas deles, serão sobrescritas com este padrão.
    </p>
  </div>
</details>

<script>
(function(){
  const root = document.getElementById('card-css-nebula-patch');
  if (!root) return;

  const STATUS_ID_MD   = 'NEBULA_MD_STACKS_CSS';
  const STATUS_ID_ORB  = 'ORB2D_CSS_V1';
  const STATUS_ID_FAB  = 'FAB_BTN_TWEAKS_V3';

  const $status = root.querySelector('[data-role="nebula-status"]');
  const $apply  = root.querySelector('[data-role="nebula-apply"]');
  const $remove = root.querySelector('[data-role="nebula-remove"]');

  const cssMarkdownStacks = `
/* === Markdown+ blocks === */
pre.md-code{
  position:relative;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.08);
  padding:12px 14px;
  border-radius:12px;
  overflow:auto;
  font:500 13px/1.5 ui-monospace,SFMono-Regular,Consolas,monospace;
  margin:12px 0;
}
pre.md-code .copy-hint{
  position:absolute;
  right:10px;
  top:10px;
  font-size:.8rem;
  opacity:.6;
}
code.code-inline{
  background:rgba(255,255,255,.06);
  padding:.1rem .3rem;
  border-radius:6px;
}

table.md-table{
  width:100%;
  border-collapse:collapse;
  margin:12px 0;
  border-radius:12px;
  overflow:hidden;
}
table.md-table th,
table.md-table td{
  border:1px solid rgba(255,255,255,.12);
  padding:8px 10px;
  vertical-align:top;
}
table.md-table th{
  background:rgba(255,255,255,.06);
  font-weight:700;
}

ul.md-list,
ol.md-list{
  padding-left:1.1rem;
  margin:10px 0;
}
ul.md-task{
  list-style:none;
  padding-left:0;
}
ul.md-task li{
  display:flex;
  gap:.5rem;
  align-items:flex-start;
  margin:6px 0;
}
ul.md-task input[type=checkbox]{
  accent-color:var(--cyan);
  pointer-events:none;
}

.callout{
  border-left:3px solid var(--cyan);
  background:rgba(255,255,255,.03);
  border-radius:12px;
  padding:12px;
  margin:12px 0;
}
.callout.warn{border-color:#ffda7a}
.callout.tip{border-color:#9ff7b9}

.hr{
  height:1px;
  border:0;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
  margin:16px 0;
}
img.md-img{
  max-width:100%;
  display:block;
  margin:10px auto;
  border-radius:12px;
}
.kbd{
  font:600 12px ui-monospace,monospace;
  background:rgba(255,255,255,.06);
  padding:.1rem .35rem;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.12);
}

/* === PATCH EQ/QUOTE/FN === */
.equation{white-space:pre-wrap}
blockquote.bq{
  border-left:3px solid var(--cyan);
  background:rgba(255,255,255,.03);
  border-radius:12px;
  padding:10px 12px;
  margin:12px 0;
  position:relative;
}
blockquote.bq .bq-line{margin:6px 0}
blockquote.bq-l2{border-left-width:6px;opacity:.96}
blockquote.bq-l3{border-left-width:9px;opacity:.92}
.callout.note{border-left:3px solid #7ad0ff}
.callout.aside{border-left:3px solid var(--muted)}
.callout.success{border-left:3px solid #9ff7b9}
.callout.danger{border-left:3px solid #ff9f9f}
.callout.question{border-left:3px solid #b7a6ff}

/* === Welcome panel & inputs === */
.welcome{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);
  border-radius:14px;
  padding:12px;
  margin:12px 0;
}
.welcome .row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
.field{
  width:min(360px,100%);
  border:1px solid rgba(255,255,255,.12);
  background:#0a0e18;
  color:var(--ink);
  border-radius:10px;
  padding:8px 10px;
}
.small{font-size:.9rem;color:var(--muted)}
.equation{white-space:pre-wrap}

/* === Master Block (Topo do Documento) === */
.master-block{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03);
  border-radius:12px;
  padding:12px;
  margin:12px 0;
}
.master-block .row{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.master-block .title{
  flex:1;
  min-width:200px;
  border:1px solid rgba(255,255,255,.12);
  background:#0a0e18;
  color:var(--ink);
  border-radius:10px;
  padding:8px 10px;
}

/* === Stacks (Home) === */
/* MOBILE-FIRST VERTICAL HARD-LOCK: sempre 1 coluna */
.stack-grid{
  display:grid;
  grid-template-columns:1fr !important;
  gap:10px;
  margin-top:10px;
}
.stack-card{
  border:1px solid rgba(255,255,255,.12);
  border-radius:12px;
  padding:10px;
  background:rgba(255,255,255,.03);
}
.stack-card h4{margin:0 0 6px 0}
.stack-card .meta{
  font-size:.85rem;
  color:var(--muted);
  margin-bottom:8px;
}
`;

  const cssOrb = `
:root{
  --orb-a: var(--grad-a);
  --orb-b: var(--grad-b);
  --orb-size: 64px;
  --orb-blur: 18px;
  --orb-ring: 0 0 0 1px rgba(255,255,255,.12) inset, 0 10px 30px rgba(0,0,0,.35);
}
#fab{
  position:fixed;
  right:14px;
  bottom:14px;
  z-index:120;
  display:flex;
  flex-direction:column;
  gap:10px;
}
#fab .fab-btn{display:none !important;}
#orb2d{
  width:var(--orb-size);
  height:var(--orb-size);
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  position:relative;
  cursor:pointer;
  box-shadow: var(--orb-ring);
  background:
    radial-gradient(120% 120% at 30% 20%, color-mix(in oklab, var(--orb-a) 65%, transparent), transparent 60%),
    radial-gradient(120% 120% at 80% 70%, color-mix(in oklab, var(--orb-b) 60%, transparent), transparent 50%),
    conic-gradient(from 0deg, color-mix(in oklab, var(--orb-b) 45%, transparent), transparent 40%, color-mix(in oklab, var(--orb-a) 45%, transparent));
  filter:saturate(1.1);
  animation: orb-spin 10s linear infinite, orb-breath 3.6s ease-in-out infinite;
  outline:none;
  -webkit-tap-highlight-color:transparent;
}
#orb2d::before{
  content:'';
  position:absolute;
  inset:6px;
  border-radius:inherit;
  background:radial-gradient(80% 80% at 50% 40%, rgba(255,255,255,.35), transparent 60%);
  mix-blend-mode:screen;
  pointer-events:none;
}
#orb2d::after{
  content:'';
  position:absolute;
  inset:0;
  border-radius:inherit;
  box-shadow:inset 0 0 30px rgba(255,255,255,.12);
  pointer-events:none;
}
#fab.open #orb2d{
  animation-duration:6s;
  box-shadow:
    0 0 0 1px rgba(255,255,255,.18) inset,
    0 14px 40px rgba(0,0,0,.45),
    0 0 80px color-mix(in oklab, var(--orb-b) 35%, transparent);
}
#orb-picker{
  position:absolute;
  right:72px;
  bottom:0;
  display:none;
  flex-direction:column;
  gap:6px;
}
#fab.show-picker #orb-picker{display:flex;}
#orb-picker .chip{
  border:1px solid rgba(255,255,255,.14);
  border-radius:10px;
  padding:.45rem .7rem;
  background:linear-gradient(42deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  color:var(--ink);
}
@keyframes orb-spin{
  to{transform:rotate(360deg);}
}
@keyframes orb-breath{
  0%,100%{filter:saturate(1) blur(0px);}
  50%{filter:saturate(1.2) blur(1px);}
}
`;

  const cssFab = `
:root{
  --fab-btn-opacity:.92;
  --fab-btn-bg:rgba(255,255,255,.10);
  --fab-btn-brd:rgba(255,255,255,.20);
}
#fab .menu{
  display:none;
  position:absolute;
  right:72px;
  bottom:0;
  gap:8px;
  flex-direction:column;
}
#fab.open .menu{display:flex;}
#fab .menu .btn,
#fab .menu button,
#fab .menu a{
  opacity:var(--fab-btn-opacity);
  border:1px solid var(--fab-btn-brd);
  background:linear-gradient(42deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
  color:var(--ink,#e8ecf6);
  border-radius:12px;
  padding:.55rem .75rem;
  font:600 14px/1.1 system-ui,sans-serif;
  box-shadow:0 6px 20px rgba(0,0,0,.25);
}
#fab .menu .btn:active{
  transform:translateY(1px);
  opacity:1;
}
`;

  function ensureStyle(id, cssText){
    let el = document.getElementById(id);
    if (!el){
      el = document.createElement('style');
      el.id = id;
      document.head.appendChild(el);
    }
    el.textContent = cssText;
    return el;
  }

  function removeStyle(id){
    const el = document.getElementById(id);
    if (el && el.parentNode){
      el.parentNode.removeChild(el);
    }
  }

  function isActive(){
    const md  = !!document.getElementById(STATUS_ID_MD);
    const orb = !!document.getElementById(STATUS_ID_ORB);
    const fab = !!document.getElementById(STATUS_ID_FAB);
    return md && orb && fab;
  }

  function updateStatus(){
    if (!$status) return;
    if (isActive()){
      $status.textContent = 'Patch Nebula Pro ATIVO (Markdown+ · Stacks · Orb · FAB).';
      $status.style.color = 'var(--accent, #9ff7b9)';
    } else {
      $status.textContent = 'Patch Nebula Pro DESATIVADO (você está no CSS base).';
      $status.style.color = 'var(--muted)';
    }
  }

  if ($apply){
    $apply.addEventListener('click', ()=>{
      ensureStyle(STATUS_ID_MD,  cssMarkdownStacks);
      ensureStyle(STATUS_ID_ORB, cssOrb);
      ensureStyle(STATUS_ID_FAB, cssFab);
      updateStatus();
    });
  }

  if ($remove){
    $remove.addEventListener('click', ()=>{
      removeStyle(STATUS_ID_MD);
      removeStyle(STATUS_ID_ORB);
      removeStyle(STATUS_ID_FAB);
      updateStatus();
    });
  }

  // status inicial
  updateStatus();
})();
</script>

<!-- CARD · Livro Vivo · Decoder 3·6·9 -->
<details
  class="stack-card"
  id="card-livro-vivo-decoder"
  data-stack-target=".apps-stacks"
  data-stack-group="apps"
  data-stack-order="20"
>
  <summary>
    <div class="stack-summary-main">
      <div class="stack-title">Livro Vivo · Decoder 3·6·9</div>
      <div class="stack-sub">
        Colar texto/arquivo e gerar preview simbólico (Builder v2).
      </div>
    </div>
    <span class="stack-pill">Tool · Texto</span>
  </summary>

  <div class="stack-body">
    <!-- SHELL LOCAL DO DECODER -->
    <div class="lv-shell">
      <section class="lv-header glass">
        <div class="lv-title-wrap">
          <h1 class="lv-title">📖 Livro Vivo • Decoder 3·6·9</h1>
          <p
            class="lv-subtitle ellip"
            title="Colar, subir arquivo e gerar a leitura ."
          >
            Colar texto, subir arquivo e gerar a leitura simbólik .
          </p>
        </div>
      </section>

      <section class="lv-grid">
        <!-- COLUNA ESQUERDA: ENTRADA -->
        <div class="lv-col glass">
          <h2 class="lv-section-title">1 · TEXTO / MARKDOWN / RTF BRUTO</h2>
          <p class="lv-hint">
            Cole qualquer coisa aqui (texto puro, MD, RTF ou até HTML bruto):
          </p>
          <textarea
            id="lv-input"
            class="lv-textarea"
            placeholder="Cole aqui seu texto bruto…"
          ></textarea>

          <div class="lv-actions">
            <button class="btn" id="lv-btn-build" data-action="autoBuild">
              ⚡ Gerar Livro (autoBuild)
            </button>
            <button class="btn btn-ghost" id="lv-btn-build-nested" data-action="autoBuildNested">
              ⭕ Gerar Aninhado (autoBuildNested)
            </button>
            <button class="btn btn-minor" id="lv-btn-clear">
              🧹 Limpar
            </button>
          </div>

          <details class="acc lv-tip">
            <summary><strong>Dica:</strong> RTF cru + HTML</summary>
            <div class="lv-tip-body">
              <p>
                Se você colar um <code>.rtf</code> cru (começando com
                <code>{\rtf1\ansi…}</code>), o decoder tenta limpar antes de montar o livro.
              </p>
              <p>HTML bruto também é convertido para texto antes de virar Markdown.</p>
            </div>
          </details>

          <hr class="lv-divider" />

          <h2 class="lv-section-title">2 · ARQUIVO (PDF/TXT/MD/RTF/HTML)</h2>
          <p class="lv-hint">Selecione um arquivo para decodificar:</p>
          <label class="lv-file-label">
            <input
              type="file"
              id="lv-file"
              accept=".txt,.md,.rtf,.html,.htm,application/pdf"
            />
            <span>📂 Escolher arquivo</span>
          </label>
          <ul class="lv-file-notes">
            <li>TXT/MD/RTF/HTML são lidos direto.</li>
            <li>PDF depende de como o navegador expõe o texto (pode vir vazio).</li>
            <li>
              Depois é só apertar <em>Gerar Livro</em> se quiser reprocessar manualmente.
            </li>
          </ul>
        </div>

        <!-- COLUNA DIREITA: SAÍDA -->
        <div class="lv-col glass">
          <h2 class="lv-section-title">3 · SAÍDA (MD NORMALIZADO)</h2>
          <p class="lv-hint">
            Texto que o Livro usou como base (pós-decodificação):
          </p>
          <div class="lv-md-toolbar">
            <button class="btn btn-minor" id="lv-btn-copy-md">📋 Copiar MD</button>
            <span class="lv-md-status" id="lv-md-status" aria-live="polite"></span>
          </div>
          <textarea
            id="lv-md-output"
            class="lv-textarea lv-md-output"
            placeholder="O Markdown normalizado aparece aqui…"
          ></textarea>

          <h2 class="lv-section-title lv-preview-title">4 · PREVIEW SIMBÓLICO</h2>
          <div id="lv-preview" class="lv-preview glass-inner">
            <p class="lv-preview-placeholder">
              Gere o livro para ver o preview simbólico aqui. <br />
              Suporte a: <code>headings</code>, <code>listas</code>,
              <code>callouts ::info</code>, <code>tabelista</code>, blocos
              <code>ascii</code>, botões <code>[[btn:acao|Rótulo]]</code> e mais.
            </p>
          </div>
        </div>
      </section>
    </div>
  </div>
</details>

<style>
  /* SCOPED · Livro Vivo Decoder dentro do card */
  #card-livro-vivo-decoder .lv-shell {
    max-width: 100%;
    margin: 0;
    padding: 4px 0 2px;
    box-sizing: border-box;
  }

  @media (min-width: 960px) {
    #card-livro-vivo-decoder .lv-shell {
      padding: 6px 0 4px;
    }
  }

  #card-livro-vivo-decoder .glass {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.9));
    border-radius: 12px;
    border: 1px solid rgba(148, 163, 184, 0.45);
    box-shadow:
      0 0 0 1px rgba(148, 163, 184, 0.2),
      0 10px 28px rgba(15, 23, 42, 0.95);
    backdrop-filter: blur(14px);
  }

  #card-livro-vivo-decoder .lv-header {
    padding: 10px 10px 8px;
    margin-bottom: 8px;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 8px;
  }

  #card-livro-vivo-decoder .lv-title {
    margin: 0;
    font-size: 13px;
    letter-spacing: 0.04em;
    color: var(--text-strong, #e5f0ff);
  }

  #card-livro-vivo-decoder .lv-subtitle {
    margin: 3px 0 0;
    font-size: 11px;
    color: var(--text-soft, #9ca3af);
  }

  #card-livro-vivo-decoder .lv-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  @media (min-width: 900px) {
    #card-livro-vivo-decoder .lv-grid {
      flex-direction: row;
      align-items: flex-start;
    }
  }

  #card-livro-vivo-decoder .lv-col {
    flex: 1 1 0;
    padding: 10px;
    box-sizing: border-box;
    min-width: 0;
  }

  #card-livro-vivo-decoder .lv-section-title {
    margin: 0 0 4px;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--text-soft, #9ca3af);
  }

  #card-livro-vivo-decoder .lv-preview-title {
    margin-top: 12px;
  }

  #card-livro-vivo-decoder .lv-hint {
    margin: 0 0 8px;
    font-size: 11px;
    color: var(--text-soft, #9ca3af);
  }

  #card-livro-vivo-decoder .lv-textarea {
    width: 100%;
    min-height: 120px;
    border-radius: 8px;
    padding: 8px 9px;
    border: 1px solid rgba(148, 163, 184, 0.6);
    background: rgba(15, 23, 42, 0.98);
    color: var(--text-strong, #e5f0ff);
    font-size: 11px;
    resize: vertical;
    outline: none;
    box-sizing: border-box;
  }

  #card-livro-vivo-decoder .lv-textarea:focus {
    border-color: rgba(56, 189, 248, 0.8);
    box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.7);
  }

  #card-livro-vivo-decoder .lv-md-output {
    min-height: 110px;
  }

  #card-livro-vivo-decoder .btn {
    border: 1px solid rgba(148, 163, 184, 0.9);
    background: radial-gradient(
        circle at 0 0,
        rgba(56, 189, 248, 0.18),
        transparent 60%
      ),
      radial-gradient(
        circle at 100% 100%,
        rgba(168, 85, 247, 0.16),
        transparent 60%
      ),
      rgba(15, 23, 42, 0.96);
    border-radius: 999px;
    color: var(--text-strong, #e5f0ff);
    backdrop-filter: blur(8px);
    padding: 5px 10px;
    font-size: 11px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: 0.18s ease;
    white-space: nowrap;
  }

  #card-livro-vivo-decoder .btn:hover {
    transform: translateY(-0.5px);
    box-shadow: 0 0 14px rgba(56, 189, 248, 0.55);
  }

  #card-livro-vivo-decoder .btn-ghost {
    background: rgba(15, 23, 42, 0.96);
    box-shadow: none;
  }

  #card-livro-vivo-decoder .btn-minor {
    border-style: dashed;
    background: rgba(15, 23, 42, 0.96);
    box-shadow: none;
  }

  #card-livro-vivo-decoder .lv-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 8px 0 6px;
  }

  #card-livro-vivo-decoder details.acc {
    margin-top: 4px;
    padding: 6px 7px;
    background: rgba(15, 23, 42, 0.98);
    border-radius: 8px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    box-shadow: 0 0 10px rgba(15, 23, 42, 0.9) inset;
    transition: 0.18s all ease;
  }

  #card-livro-vivo-decoder details.acc[open] {
    box-shadow:
      0 0 12px rgba(56, 189, 248, 0.4),
      0 0 26px rgba(129, 140, 248, 0.4);
  }

  #card-livro-vivo-decoder details.acc summary {
    cursor: pointer;
    list-style: none;
    font-size: 11px;
    color: var(--text-strong, #e5f0ff);
  }

  #card-livro-vivo-decoder details.acc summary::-webkit-details-marker {
    display: none;
  }

  #card-livro-vivo-decoder .lv-tip-body {
    margin-top: 4px;
    font-size: 11px;
    color: var(--text-soft, #9ca3af);
  }

  #card-livro-vivo-decoder .lv-divider {
    border: none;
    border-top: 1px dashed rgba(148, 163, 184, 0.8);
    margin: 10px 0 8px;
  }

  #card-livro-vivo-decoder .lv-file-label {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 5px 9px;
    border-radius: 999px;
    border: 1px dashed rgba(148, 163, 184, 0.9);
    cursor: pointer;
    font-size: 11px;
    color: var(--text-strong, #e5f0ff);
    background: rgba(15, 23, 42, 0.98);
  }

  #card-livro-vivo-decoder .lv-file-label input {
    display: none;
  }

  #card-livro-vivo-decoder .lv-file-label:hover {
    border-style: solid;
    box-shadow: 0 0 13px rgba(56, 189, 248, 0.6);
  }

  #card-livro-vivo-decoder .lv-file-notes {
    margin: 8px 0 0;
    padding-left: 16px;
    font-size: 10px;
    color: var(--text-soft, #9ca3af);
  }

  #card-livro-vivo-decoder .lv-md-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
    margin: 0 0 6px;
  }

  #card-livro-vivo-decoder .lv-md-status {
    font-size: 10px;
    color: var(--text-soft, #9ca3af);
    min-height: 1em;
  }

  #card-livro-vivo-decoder .lv-preview {
    margin-top: 6px;
    padding: 8px 9px 9px;
    min-height: 90px;
    max-height: 260px;
    overflow: auto;
    border-radius: 9px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    background: radial-gradient(
        circle at 0 0,
        rgba(56, 189, 248, 0.25),
        transparent 60%
      ),
      radial-gradient(
        circle at 100% 100%,
        rgba(129, 140, 248, 0.22),
        transparent 60%
      ),
      rgba(15, 23, 42, 0.98);
    font-size: 11px;
  }

  #card-livro-vivo-decoder .glass-inner {
    backdrop-filter: blur(12px);
  }

  #card-livro-vivo-decoder .lv-preview-placeholder {
    margin: 0;
    color: var(--text-soft, #9ca3af);
    font-size: 10px;
  }

  #card-livro-vivo-decoder .callout {
    padding: 4px 6px;
    border-radius: 6px;
    margin: 4px 0;
    border: 1px solid rgba(148, 163, 184, 0.9);
    font-size: 10px;
  }

  #card-livro-vivo-decoder .callout.info {
    border-color: rgba(56, 189, 248, 0.9);
  }

  #card-livro-vivo-decoder .callout.warn {
    border-color: #f97316;
  }

  #card-livro-vivo-decoder .callout.success {
    border-color: #22c55e;
  }

  #card-livro-vivo-decoder .callout.question {
    border-color: #a855f7;
  }

  #card-livro-vivo-decoder .callout.aside {
    border-style: dashed;
    opacity: 0.95;
  }

  #card-livro-vivo-decoder ul.tbl-list {
    margin: 4px 0 6px 14px;
    padding-left: 8px;
    font-size: 10px;
  }

  #card-livro-vivo-decoder #lv-preview h1,
  #card-livro-vivo-decoder #lv-preview h2,
  #card-livro-vivo-decoder #lv-preview h3,
  #card-livro-vivo-decoder #lv-preview h4,
  #card-livro-vivo-decoder #lv-preview h5,
  #card-livro-vivo-decoder #lv-preview h6 {
    margin: 4px 0 2px;
    font-size: 11px;
  }

  #card-livro-vivo-decoder #lv-preview p {
    margin: 3px 0;
  }

  #card-livro-vivo-decoder #lv-preview ul,
  #card-livro-vivo-decoder #lv-preview ol {
    margin: 3px 0 3px 16px;
  }

  #card-livro-vivo-decoder #lv-preview blockquote {
    margin: 4px 0;
    padding-left: 8px;
    border-left: 2px solid rgba(56, 189, 248, 0.8);
    font-size: 10px;
    color: var(--text-soft, #9ca3af);
  }

  #card-livro-vivo-decoder #lv-preview code {
    font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
      Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 10px;
    background: rgba(15, 23, 42, 0.98);
    padding: 1px 4px;
    border-radius: 4px;
  }

  #card-livro-vivo-decoder pre.md-code {
    margin: 4px 0;
    padding: 5px 6px;
    border-radius: 6px;
    background: rgba(15, 23, 42, 0.98);
    overflow: auto;
    font-size: 10px;
  }

  #card-livro-vivo-decoder #lv-preview .btn {
    font-size: 10px;
    padding: 3px 7px;
    border-radius: 999px;
  }

  #card-livro-vivo-decoder .ellip {
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
</style>

<script>
  // ===================== convertLivroVivo.js =====================
  (function (global) {
    function lvEscapeHtml(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function inlineLivroVivo(text) {
      if (!text) return "";

      text = text.replace(
        /\[\[btn:([^\]|]+)(?:\|([^\]]+))?\]\]/g,
        function (_m, action, label) {
          const act = lvEscapeHtml(action.trim());
          const lab = lvEscapeHtml((label || action).trim());
          return (
            '<button class="btn" data-action="' + act + '">' + lab + "</button>"
          );
        }
      );

      text = text.replace(
        /\[([^\]]+)\]\(([^)]+)\)/g,
        function (_m, label, href) {
          return (
            '<a href="' +
            lvEscapeHtml(href) +
            '" target="_blank" rel="noopener">' +
            lvEscapeHtml(label) +
            "</a>"
          );
        }
      );

      text = text.replace(/`([^`]+)`/g, "<code>$1</code>");

      text = text.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
      text = text.replace(/\*([^*]+)\*/g, "<em>$1</em>");

      return text;
    }

    function convertLivroVivo(md) {
      if (md == null) return "";
      md = String(md).replace(/\r\n?/g, "\n");

      const lines = md.split("\n");
      const out = [];
      let i = 0;
      let inCode = false;
      let codeLang = "";
      let codeBuf = [];

      function flushCode() {
        if (!inCode) return;
        const code = codeBuf.join("\n");
        if (codeLang === "ascii") {
          out.push(
            '<pre class="md-code ascii"><code>' +
              lvEscapeHtml(code) +
              "</code></pre>"
          );
        } else {
          const langClass = codeLang ? " md-code-" + codeLang : "";
          out.push(
            '<pre class="md-code' +
              langClass +
              '"><code>' +
              lvEscapeHtml(code) +
              "</code></pre>"
          );
        }
        inCode = false;
        codeLang = "";
        codeBuf = [];
      }

      function flushParagraph(buf) {
        if (!buf.length) return;
        const txt = buf.join(" ").trim();
        if (!txt) {
          buf.length = 0;
          return;
        }
        out.push("<p>" + inlineLivroVivo(txt) + "</p>");
        buf.length = 0;
      }

      while (i < lines.length) {
        let line = lines[i];

        if (inCode) {
          if (/^```/.test(line)) {
            flushCode();
            i++;
            continue;
          }
          codeBuf.push(line);
          i++;
          continue;
        }

        const codeMatch = line.match(/^```(\w+)?\s*$/);
        if (codeMatch) {
          flushParagraph([]);
          inCode = true;
          codeLang = (codeMatch[1] || "").toLowerCase();
          codeBuf = [];
          i++;
          continue;
        }

        if (/^\s*$/.test(line)) {
          flushParagraph([]);
          i++;
          continue;
        }

        const h = line.match(/^(#{1,6})\s+(.*)$/);
        if (h) {
          flushParagraph([]);
          const level = h[1].length;
          out.push(
            "<h" +
              level +
              ">" +
              inlineLivroVivo(h[2].trim()) +
              "</h" +
              level +
              ">"
          );
          i++;
          continue;
        }

        const call = line.match(/^::(info|warn|success|question|aside)\s+(.*)$/i);
        if (call) {
          flushParagraph([]);
          const kind = call[1].toLowerCase();
          const body = call[2].trim();
          out.push(
            '<div class="callout ' +
              kind +
              '">' +
              inlineLivroVivo(body) +
              "</div>"
          );
          i++;
          continue;
        }

        if (
          /^\s*\|.*\|\s*$/.test(line) &&
          i + 1 < lines.length &&
          /^\s*\|[-:]+.*\|\s*$/.test(lines[i + 1])
        ) {
          flushParagraph([]);

          const tableLines = [];
          tableLines.push(line);
          tableLines.push(lines[i + 1]);
          let j = i + 2;
          while (j < lines.length && /^\s*\|.*\|\s*$/.test(lines[j])) {
            tableLines.push(lines[j]);
            j++;
          }

          const header = tableLines[0];
          const sep = tableLines[1];
          out.push("<p>" + lvEscapeHtml(header) + "</p>");
          out.push("<p>" + lvEscapeHtml(sep) + "</p>");

          if (tableLines.length > 2) {
            out.push('<ul class="tbl-list">');
            for (let k = 2; k < tableLines.length; k++) {
              const raw = tableLines[k];
              const cells = raw
                .replace(/^\s*\||\|\s*$/g, "")
                .split("|")
                .map(function (c) {
                  return c.trim();
                });
              if (cells.length < 2) {
                out.push("<li>" + lvEscapeHtml(raw.trim()) + "</li>");
              } else {
                const c1 = cells[0] || "";
                const c2 = cells[1] || "";
                const rest = cells.slice(2).join(" | ");
                const lineStr = "| " + c1 + " | (" + c2 + ") | " + rest + " |";
                out.push("<li>" + lvEscapeHtml(lineStr) + "</li>");
              }
            }
            out.push("</ul>");
          }

          i = j;
          continue;
        }

        const listMatch = line.match(/^\s*([-*+]|\d+\.)\s+(.*)$/);
        if (listMatch) {
          flushParagraph([]);
          const isOrdered = /^\d+\./.test(listMatch[1]);
          const tag = isOrdered ? "ol" : "ul";
          const items = [];
          let j = i;
          while (j < lines.length) {
            const lm = lines[j].match(/^\s*([-*+]|\d+\.)\s+(.*)$/);
            if (!lm) break;
            items.push(lm[2]);
            j++;
          }
          out.push("<" + tag + ">");
          for (const item of items) {
            out.push("<li>" + inlineLivroVivo(item.trim()) + "</li>");
          }
          out.push("</" + tag + ">");
          i = j;
          continue;
        }

        if (/^\s*>/.test(line)) {
          flushParagraph([]);
          const bq = [];
          let j = i;
          while (j < lines.length && /^\s*>/.test(lines[j])) {
            bq.push(
              lines[j]
                .replace(/^\s*>+\s?/, "")
                .trim()
            );
            j++;
          }
          out.push("<blockquote>" + inlineLivroVivo(bq.join(" ")) + "</blockquote>");
          i = j;
          continue;
        }

        let paraBuf = [line.trim()];
        i++;
        while (
          i < lines.length &&
          !/^\s*$/.test(lines[i]) &&
          !/^```(\w+)?\s*$/.test(lines[i]) &&
          !/^(#{1,6})\s+/.test(lines[i]) &&
          !/^::(info|warn|success|question|aside)\s+/.test(lines[i]) &&
          !/^\s*\|.*\|\s*$/.test(lines[i]) &&
          !/^\s*([-*+]|\d+\.)\s+/.test(lines[i]) &&
          !/^\s*>/.test(lines[i])
        ) {
          paraBuf.push(lines[i].trim());
          i++;
        }
        flushParagraph(paraBuf);
      }

      flushCode();

      return out.join("\n");
    }

    global.convertLivroVivo = convertLivroVivo;
    global.inlineLivroVivo = inlineLivroVivo;
  })(window);

  // ===================== Helpers de Decodificação =====================
  function lv_isRtf(text) {
    return /^\s*{\s*\\rtf1/i.test(text || "");
  }

  function lv_stripRtf(text) {
    return String(text || "")
      .replace(/\\par[d]?/g, "\n")
      .replace(/\\'([0-9a-fA-F]{2})/g, function (_, hex) {
        try {
          return decodeURIComponent("%" + hex);
        } catch (_e) {
          return "";
        }
      })
      .replace(/\\[a-zA-Z]+-?\d* ?/g, "")
      .replace(/[{}]/g, "")
      .replace(/\n{3,}/g, "\n\n")
      .trim();
  }

  function lv_stripHtml(html) {
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    return tmp.textContent || tmp.innerText || "";
  }

  // ===================== AutoBuild / Wiring dentro do card =====================
  (function () {
    const $input = document.getElementById("lv-input");
    const $file = document.getElementById("lv-file");
    const $mdOut = document.getElementById("lv-md-output");
    const $preview = document.getElementById("lv-preview");
    const $btnBuild = document.getElementById("lv-btn-build");
    const $btnBuildNested = document.getElementById("lv-btn-build-nested");
    const $btnClear = document.getElementById("lv-btn-clear");
    const $btnCopyMd = document.getElementById("lv-btn-copy-md");
    const $mdStatus = document.getElementById("lv-md-status");

    if (!$input || !$mdOut || !$preview) return;

    let lastSourceLabel = "";

    function setMd(text, label) {
      $mdOut.value = text || "";
      lastSourceLabel = label || "";
      if ($mdStatus) {
        $mdStatus.textContent = text
          ? label
            ? "Base gerada de " + label + "."
            : "Base MD atualizada."
          : "";
      }
    }

    function renderPreview() {
      const md = $mdOut.value || $input.value || "";
      const html = window.convertLivroVivo ? window.convertLivroVivo(md) : "";
      if (!html) {
        $preview.innerHTML =
          '<p class="lv-preview-placeholder">Nada para exibir ainda. Gere o livro para ver o preview simbólico aqui.</p>';
        return;
      }
      $preview.innerHTML = html;
    }

    function autoBuildBase() {
      const raw = $input.value || "";
      if (!raw.trim()) {
        setMd("", "");
        renderPreview();
        return;
      }

      let base = raw;

      if (lv_isRtf(base)) {
        base = lv_stripRtf(base);
      } else if (
        /^\s*<!doctype html/i.test(base) ||
        /^\s*<html[\s>]/i.test(base) ||
        /<\/[a-z][^>]*>\s*$/i.test(base)
      ) {
        base = lv_stripHtml(base);
      }

      setMd(base, lastSourceLabel || "texto colado");
      renderPreview();
    }

    function autoBuildNested() {
      autoBuildBase();
      if ($mdStatus) {
        $mdStatus.textContent =
          "Estrutura aninhada usa a mesma base atual. (autoBuildNested stub)";
      }
    }

    function clearAll() {
      $input.value = "";
      setMd("", "");
      $preview.innerHTML =
        '<p class="lv-preview-placeholder">Gere o livro para ver o preview simbólico aqui.</p>';
    }

    if ($file) {
      $file.addEventListener("change", function (ev) {
        const file = ev.target.files && ev.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        const label = file.name || "arquivo";

        reader.onload = function (e) {
          const content = String(e.target.result || "");
          let text = content;

          if (file.type === "application/pdf") {
            setMd(text.trim(), label + " (PDF bruto)");
          } else if (/\.rtf$/i.test(file.name) || lv_isRtf(text)) {
            setMd(lv_stripRtf(text), label + " (RTF → texto)");
          } else if (/\.html?$/i.test(file.name)) {
            setMd(lv_stripHtml(text), label + " (HTML → texto)");
          } else {
            setMd(text.trim(), label);
          }

          renderPreview();
        };

        reader.readAsText(file);
      });
    }

    if ($btnBuild) $btnBuild.addEventListener("click", autoBuildBase);
    if ($btnBuildNested) $btnBuildNested.addEventListener("click", autoBuildNested);
    if ($btnClear) $btnClear.addEventListener("click", clearAll);

    if ($btnCopyMd) {
      $btnCopyMd.addEventListener("click", function () {
        if (!$mdOut.value) {
          if ($mdStatus) $mdStatus.textContent = "Nada para copiar ainda.";
          return;
        }
        navigator.clipboard
          .writeText($mdOut.value)
          .then(function () {
            if ($mdStatus)
              $mdStatus.textContent = "MD copiado para a área de transferência.";
          })
          .catch(function () {
            if ($mdStatus)
              $mdStatus.textContent = "Não foi possível copiar automaticamente.";
          });
      });
    }

    renderPreview();
  })();
</script>

  <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker
        .register('./sw.js')
        .catch(err => console.error('SW erro:', err));
    });
  }
</script>
</body>
</html>
</body>
</html>
